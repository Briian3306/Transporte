<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check de Verificación de Vehículo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <style>
        @media print {
            .no-print {
                display: none;
            }
            button {
                display: none;
            }
        }
        /* Estilo para input radio personalizado más grande y accesible en móviles */
        .radio-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }
        .radio-container input[type="radio"] {
            transform: scale(1.5);
            margin: 0;
            cursor: pointer;
        }
        /* Mejora la experiencia táctil */
        .touch-target {
            min-height: 44px;
        }
        @media (max-width: 640px) {
            .table-scroll {
                max-height: 70vh;
                overflow-y: auto;
            }
            .touch-target {
                min-height: 48px;
            }
            .radio-container input[type="radio"] {
                transform: scale(1.8);
            }
        }
        /* Espacio para los botones flotantes en móvil */
        .content-wrapper {
            padding-bottom: 120px; /* Espacio para los botones flotantes en móvil */
        }
        @media (min-width: 768px) {
            .content-wrapper {
                padding-bottom: 0; /* Sin padding en desktop */
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-4">
    <form id="formVehiculo" method="post" action="#" class="max-w-6xl mx-auto content-wrapper">
        <div class="bg-white shadow-md rounded-lg overflow-hidden border border-gray-300">
            <!-- Encabezado - Responsive -->
            <div class="flex flex-col md:flex-row border-b border-gray-300">
                <div class="w-full md:w-1/5 p-3 md:p-4 border-b md:border-b-0 md:border-r border-gray-300 flex flex-col items-center justify-center">
                    <div class="text-center mt-2 font-semibold">TRANSPORTE IBARRA S.A.</div>
                </div>
                <div class="w-full md:w-3/5 p-3 md:p-4 border-b md:border-b-0 md:border-r border-gray-300 flex items-center justify-center">
                    <h1 class="text-lg md:text-xl font-bold text-center">CHECK DE VERIFICACIÓN DE VEHÍCULO</h1>
                </div>
                <div class="w-full md:w-1/5 p-3 md:p-4 flex items-center justify-center">
                    <div class="text-lg md:text-xl font-bold">FORMULARIO A1</div>
                </div>
            </div>

            <!-- Información básica - Responsive -->
            <div class="flex flex-col md:flex-row border-b border-gray-300">
                <div class="w-full md:w-1/4 p-2 md:p-4 bg-gray-50 font-bold flex items-center justify-center md:justify-start border-b md:border-b-0 md:border-r border-gray-300">FECHA Y HORA</div>
                <div class="w-full md:w-1/4 p-2 md:p-4 border-b md:border-b-0 md:border-r border-gray-300">
                    <input type="datetime-local" name="fechaHora" id="fechaHora" required 
                          class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 touch-target">
                </div>
                <div class="w-full md:w-1/4 p-2 md:p-4 bg-gray-50 font-bold flex items-center justify-center md:justify-start border-b md:border-b-0 md:border-r border-gray-300">CHOFER</div>
                <div class="w-full md:w-1/4 p-2 md:p-4">
                    <input type="text" name="chofer" id="chofer" required 
                          class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 touch-target">
                </div>
            </div>
            <div class="flex flex-col md:flex-row border-b border-gray-300">
                <div class="w-full md:w-1/4 p-2 md:p-4 bg-gray-50 font-bold flex items-center justify-center md:justify-start border-b md:border-b-0 md:border-r border-gray-300">TRACTOR</div>
                <div class="w-full md:w-1/4 p-2 md:p-4 border-b md:border-b-0 md:border-r border-gray-300">
                    <input type="text" name="tractor" id="tractor" required 
                          class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 touch-target">
                </div>
                <div class="w-full md:w-1/4 p-2 md:p-4 bg-gray-50 font-bold flex items-center justify-center md:justify-start border-b md:border-b-0 md:border-r border-gray-300">SEMI</div>
                <div class="w-full md:w-1/4 p-2 md:p-4">
                    <input type="text" name="semi" id="semi" required 
                          class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 touch-target">
                </div>
            </div>

            <!-- Título de sección -->
            <div class="p-3 md:p-4 text-center font-bold bg-gray-200 border-b border-gray-300">
                INSPECCIÓN VEHICULAR
            </div>

            <!-- Contenedor dinámico para las secciones -->
            <div id="secciones-container">
                <!-- Las secciones se generarán dinámicamente desde el JSON -->
            </div>
            
            <!-- Mensaje de estado de completado -->
            <div id="status-bar" class="p-3 text-center bg-gray-100 border-t border-gray-300 hidden">
                <span id="status-message" class="font-medium"></span>
                <div class="w-full bg-gray-300 rounded-full h-4 mt-2">
                    <div id="progress-bar" class="bg-green-600 h-4 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- Selector de modo de inspección -->
            <div class="p-3 md:p-4 text-center bg-yellow-100 border-t border-gray-300">
                <button type="button" id="btnModoInspeccionParcial" class="w-full md:w-auto bg-yellow-500 text-white px-4 py-3 rounded-lg font-bold hover:bg-yellow-600 transition-colors touch-target">
                    MODO PARCIAL (Solo secciones 5, 6 y 7)
                </button>
            </div>
        </div>
        
        <!-- Botones flotantes para móvil y fijos para desktop -->
        <div class="fixed bottom-0 left-0 w-full p-3 bg-white border-t border-gray-300 shadow-lg md:shadow-none md:static md:mt-6 md:flex md:justify-between no-print z-10">
            <button type="submit" class="w-full md:w-auto bg-green-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-green-700 transition-colors mb-2 md:mb-0 touch-target">
                Guardar Inspección
            </button>
            <div class="flex space-x-2 w-full md:w-auto">
                <button type="button" id="btnExpandirTodo" class="w-1/2 md:w-auto bg-gray-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-gray-700 transition-colors touch-target">
                    Expandir Todo
                </button>
                <button type="button" id="btnPantallaCompleta" class="w-1/2 md:w-auto bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition-colors touch-target" title="Pantalla Completa">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                    </svg>
                </button>
            </div>
        </div>
    </form>

    <!-- Modal de Opciones de Guardado -->
    <div id="modalGuardar" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-11/12 sm:w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Guardar y Generar PDF</h3>
                <div class="mt-2 px-7 py-3 space-y-3">
                    <p class="text-sm text-gray-500">
                        Elige qué hacer con el PDF después de guardar la inspección:
                    </p>
                    <button id="btnGuardarCompartir" class="w-full block bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Guardar y Compartir
                    </button>
                    <button id="btnGuardarAbrir" class="w-full block bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                        Guardar y Abrir PDF
                    </button>
                    <button id="btnGuardarDescargar" class="w-full block bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                        Solo Guardar (Descargar PDF)
                    </button>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="btnCancelarModal" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Datos para generar las secciones del formulario
        const datosFormulario = {
            secciones: [
                {
                    id: "sistemaElectrico",
                    titulo: "1-SISTEMA ELECTRICO",
                    tipo: "check",
                    items: [
                        { id: "lucesCompleto", nombre: "Control de Luces completo" },
                        { id: "limpiaparabrisas", nombre: "Limpiaparabrisas" },
                        { id: "alarmaRetroceso", nombre: "Alarma de retroceso" },
                        { id: "bocina", nombre: "Bocina" },
                        { id: "tableroInstrumentos", nombre: "Tablero/instrumentos" },
                        { id: "desempanador", nombre: "Desempañador" },
                        { id: "tacografo", nombre: "Tacografo" },
                        { id: "vigia", nombre: "Vigia" }
                    ]
                },
                {
                    id: "seccionTractor",
                    titulo: "2-TRACTOR",
                    tipo: "check",
                    items: [
                        { id: "fluidos", nombre: "Fluidos" },
                        { id: "presionAireFreno", nombre: "Precion de aire / Sist. Freno" },
                        { id: "puertasAsientos", nombre: "Puertas y asientos" },
                        { id: "manijasTrabasAlzavidrios", nombre: "Manijas, trabas, alzavidrios" },
                        { id: "estribos", nombre: "Estribos" },
                        { id: "espejosRetrovisores", nombre: "Espejos retrovisores" },
                        { id: "parabrisasLuneta", nombre: "Parabrisas/luneta" },
                        { id: "cinturonSeguridad", nombre: "Cinturon de seguridad" },
                        { id: "calefaccionAire", nombre: "Calefaccion/ Aire Acond." },
                        { id: "guardabarroTractor", nombre: "Guardabarro" }, 
                        { id: "paragolpesTractor", nombre: "Paragolpes completos" }, 
                        { id: "tanqueCombustible", nombre: "Tanque de combustible" },
                        { id: "cubiertasTractor", nombre: "Cubiertas" }, 
                        { id: "cubiertaAuxilioTractor", nombre: "Cubierta de Auxilio" }, 
                        { id: "gatoHidraulico", nombre: "Gato hidraulico" },
                        { id: "llaveRueda", nombre: "Llave de rueda" },
                        { id: "manijaCabina", nombre: "Manija p/cabina" }
                    ]
                },
                {
                    id: "semirremolque",
                    titulo: "3-SEMIRREMOLQUE",
                    tipo: "check",
                    items: [
                        { id: "parantes", nombre: "Parantes" },
                        { id: "barandas", nombre: "Barandas" },
                        { id: "compuertaTrasera", nombre: "Compuerta trasera" },
                        { id: "paragolpesSemi", nombre: "Paragolpes completos" }, 
                        { id: "guardabarroSemi", nombre: "Guardabarro" }, 
                        { id: "alarmaVuelco", nombre: "Alarma de vuelco" },
                        { id: "cubiertasSemi", nombre: "Cubiertas" }, 
                        { id: "cubiertaAuxilioSemi", nombre: "Cubierta de Auxilio" } 
                    ]
                },
                {
                    id: "general",
                    titulo: "4-GENERAL",
                    tipo: "check",
                    items: [
                        { id: "danos", nombre: "Daños" },
                        { id: "perdidasFluidos", nombre: "Perdidas de Fluidos" },
                        { id: "frenos", nombre: "Frenos" },
                        { id: "chapasPatentes", nombre: "Chapas patentes" },
                        { id: "limpieza", nombre: "Limpieza" },
                        { id: "grafica", nombre: "Grafica" }
                    ]
                },
                {
                    id: "elementosSeguridad",
                    titulo: "5-ELEMENTOS DE SEGURIDAD",
                    tipo: "check",
                    items: [
                        { id: "extintorSemi", nombre: "Extintor semi" },
                        { id: "extintorCabina", nombre: "Extintor Cabina" },
                        { id: "botiquin", nombre: "Botiquin de primeros auxilios" },
                        { id: "conosSeguridad", nombre: "Conos de seguridad" },
                        { id: "cunasGoma", nombre: "Cuñas de goma" },
                        { id: "banderines", nombre: "Banderines" },
                        { id: "cintasReflectivas", nombre: "Cintas reflectivas" },
                        { id: "cartelesSeguridad", nombre: "Carteles de seguridad" }
                    ]
                },
                {
                    id: "elementosEPP", 
                    titulo: "6-ELEMENTOS DE EPP", 
                    tipo: "check",
                    items: [
                        { id: "casco", nombre: "Casco" },
                        { id: "calzadoSeguridad", nombre: "Calzado de seguridad" },
                        { id: "anteojosSeguridad", nombre: "Anteojos de seguridad" },
                        { id: "guantes", nombre: "Guantes" },
                        { id: "chalecoReflectivo", nombre: "Chaleco reflectivo" },
                        { id: "proteccionAuditiva", nombre: "Proteccion auditiva" },
                        { id: "arnes", nombre: "Arnes" },
                        { id: "mangaAnticorte", nombre: "Guantes/Manga anticorte" }
                    ]
                },
                {
                    id: "elementosCargas",
                    titulo: "7-ELEMENTOS DE CARGAS",
                    tipo: "cantidad",
                    items: [
                        { id: "juegoArcos", nombre: "JUEGO DE ARCOS" },
                        { id: "cadenas", nombre: "CADENAS" },
                        { id: "cantoneras", nombre: "CANTONERAS" },
                        { id: "cunasBobinas", nombre: "CUÑAS BOBINAS" },
                        { id: "cunasAlambron", nombre: "CUÑAS ALAMBRON" },
                        { id: "estaqueras", nombre: "ESTAQUERAS" },
                        { id: "juegoFajasChicas", nombre: "JUEGO DE FAJAS CHICAS" },
                        { id: "juegoFajasAncha", nombre: "JUEGO DE FAJAS ANCHA" },
                        { id: "geomantas", nombre: "GEOMANTAS" },
                        { id: "kitAntiderrame", nombre: "KIT ANTIDERRAME" },
                        { id: "lonaGrande", nombre: "LONA GRANDE" },
                        { id: "lonaDobleEnlonado", nombre: "LONA DOBLE ENLONADO" },
                        { id: "ponchosBobina", nombre: "PONCHOS BOBINA" },
                        { id: "ponchosBobinon", nombre: "PONCHOS BOBINON" },
                        { id: "tacosFinos", nombre: "TACOS FINOS" },
                        { id: "tacosBobina", nombre: "TACOS BOBINA" },
                        { id: "sogaPrecinto", nombre: "SOGA PRECINTO" }
                    ]
                }
            ]
        };

        // Variable global para el modo de inspección
        let modoInspeccionParcial = false;

        // Función para generar secciones a partir del JSON
        function generarSecciones(datos) {
            const contenedor = document.getElementById('secciones-container');
            contenedor.innerHTML = '';
            
            datos.secciones.forEach(seccion => {
                let contenidoTabla = '';
                
                if (seccion.tipo === "check") {
                    contenidoTabla = `
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-300 p-2 md:p-3 text-left">ITEMS A CONTROLAR</th>
                                <th class="border border-gray-300 p-2 md:p-3 text-center w-10 md:w-12">SI</th>
                                <th class="border border-gray-300 p-2 md:p-3 text-center w-10 md:w-12">NO</th>
                                <th class="border border-gray-300 p-2 md:p-3 text-center w-10 md:w-12">N/A</th>
                                <th class="border border-gray-300 p-2 md:p-3 text-left">OBSERVACIONES</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${seccion.items.map(item => `
                                <tr class="item-row touch-target" data-item="${item.id}">
                                    <td class="border border-gray-300 p-2 md:p-3">${item.nombre}</td>
                                    <td class="border border-gray-300 p-1 text-center">
                                        <div class="radio-container">
                                            <input type="radio" name="${item.id}" value="si" required
                                                   class="radio-input" data-seccion="${seccion.id}">
                                        </div>
                                    </td>
                                    <td class="border border-gray-300 p-1 text-center">
                                        <div class="radio-container">
                                            <input type="radio" name="${item.id}" value="no"
                                                   class="radio-input" data-seccion="${seccion.id}">
                                        </div>
                                    </td>
                                    <td class="border border-gray-300 p-1 text-center">
                                        <div class="radio-container">
                                            <input type="radio" name="${item.id}" value="na"
                                                   class="radio-input" data-seccion="${seccion.id}">
                                        </div>
                                    </td>
                                    <td class="border border-gray-300 p-2 md:p-3">
                                        <textarea name="obs_${item.id}" 
                                                  class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                } else if (seccion.tipo === "cantidad") {
                    contenidoTabla = `
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-300 p-2 md:p-3 text-left">ITEMS A CONTROLAR</th>
                                <th class="border border-gray-300 p-2 md:p-3 text-center w-24 md:w-32">CANTIDAD</th>
                                <th class="border border-gray-300 p-2 md:p-3 text-left">OBSERVACIONES</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${seccion.items.map(item => `
                                <tr class="item-row touch-target" data-item="${item.id}">
                                    <td class="border border-gray-300 p-2 md:p-3">${item.nombre}</td>
                                    <td class="border border-gray-300 p-2 md:p-3">
                                        <input type="number" name="${item.id}" min="0" required
                                               class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm cantidad-input"
                                               data-seccion="${seccion.id}" value="0">
                                    </td>
                                    <td class="border border-gray-300 p-2 md:p-3">
                                        <textarea name="obs_${item.id}" 
                                                  class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                }

                const seccionHTML = `
                    <div class="seccion mb-2 md:mb-4 section-container" data-id="${seccion.id}">
                        <div class="bg-gray-100 p-3 md:p-4 cursor-pointer flex justify-between items-center section-header touch-target" data-section="${seccion.id}">
                            <h2 class="font-bold">${seccion.titulo}</h2>
                            <div class="flex items-center">
                                <span class="progress-indicator text-xs text-gray-600 mr-2" id="progress-${seccion.id}">0/${seccion.items.length}</span>
                                <span class="text-xl font-bold toggle-icon">+</span>
                            </div>
                        </div>
                        <div class="section-content hidden" id="${seccion.id}">
                            <div class="overflow-x-auto table-scroll">
                                <table class="w-full border-collapse">
                                    ${contenidoTabla}
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                contenedor.innerHTML += seccionHTML;
            });
        }

        // Cargar datos de JSON personalizado
        function cargarDatosJSON(jsonURL) {
            fetch(jsonURL)
                .then(response => response.json())
                .then(data => {
                    generarSecciones(data);
                    configurarSecciones();
                    configurarRadioInputs();
                    actualizarProgreso();
                })
                .catch(error => {
                    console.error('Error al cargar el JSON:', error);
                    // Si falla, usamos los datos predeterminados
                    generarSecciones(datosFormulario);
                    configurarSecciones();
                    configurarRadioInputs();
                    actualizarProgreso();
                });
        }

        // Función para configurar las secciones desplegables
        function configurarSecciones() {
            // Configurar eventos para las secciones desplegables
            const sectionHeaders = document.querySelectorAll('.section-header');
            
            sectionHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    const content = document.getElementById(sectionId);
                    const toggleIcon = this.querySelector('.toggle-icon');
                    
                    // Toggle active class
                    content.classList.toggle('hidden');
                    toggleIcon.textContent = content.classList.contains('hidden') ? '+' : '-';
                });
            });
        }

        // Configurar eventos para radios y mejorar UX móvil
        function configurarRadioInputs() {
            const radios = document.querySelectorAll('.radio-input');
            const cantidadInputs = document.querySelectorAll('.cantidad-input');
            
            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const row = this.closest('.item-row');
                    row.classList.add('bg-green-50');
                    actualizarProgresoSeccion(this.getAttribute('data-seccion'));
                    actualizarProgreso();
                });
                
                const container = radio.closest('.radio-container');
                container.addEventListener('click', function(e) {
                    if (e.target !== radio) {
                        radio.checked = true;
                        const event = new Event('change');
                        radio.dispatchEvent(event);
                    }
                });
            });

            cantidadInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const row = this.closest('.item-row');
                    if (this.value && this.value > 0) {
                        row.classList.add('bg-green-50');
                    } else {
                        row.classList.remove('bg-green-50');
                    }
                    actualizarProgresoSeccion(this.getAttribute('data-seccion'));
                    actualizarProgreso();
                });
            });
        }
        
        // Actualizar progreso de una sección específica
        function actualizarProgresoSeccion(seccionId) {
            const seccion = document.getElementById(seccionId);
            const totalItems = seccion.querySelectorAll('.item-row').length;
            const completadosRadio = seccion.querySelectorAll('.item-row input[type="radio"]:checked').length;
            const completadosCantidad = Array.from(seccion.querySelectorAll('.item-row input[type="number"]'))
                .filter(input => input.value && input.value > 0).length;
            const completados = completadosRadio + completadosCantidad;
            
            const progressIndicator = document.getElementById(`progress-${seccionId}`);
            if (progressIndicator) {
                progressIndicator.textContent = `${completados}/${totalItems}`;
                
                if (completados === totalItems) {
                    progressIndicator.classList.add('text-green-600', 'font-bold');
                    progressIndicator.classList.remove('text-gray-600');
                    const header = document.querySelector(`.section-header[data-section="${seccionId}"]`);
                    header.classList.add('bg-green-100');
                } else {
                    progressIndicator.classList.remove('text-green-600', 'font-bold');
                    progressIndicator.classList.add('text-gray-600');
                    const header = document.querySelector(`.section-header[data-section="${seccionId}"]`);
                    header.classList.remove('bg-green-100');
                }
            }
        }
        
        // Actualizar progreso global del formulario
        function actualizarProgreso() {
            // Seleccionar solo los items en secciones visibles
            const itemsVisibles = Array.from(document.querySelectorAll('.item-row')).filter(item => {
                const seccionContainer = item.closest('.section-container');
                return seccionContainer && seccionContainer.style.display !== 'none';
            });
            
            const totalItems = itemsVisibles.length;
            
            // Contar solo radios completados en secciones visibles
            const completadosRadio = itemsVisibles.filter(item => {
                const itemId = item.getAttribute('data-item');
                return document.querySelector(`input[type="radio"][name="${itemId}"]:checked`);
            }).length;
            
            // Contar solo cantidades completadas en secciones visibles
            const completadosCantidad = itemsVisibles.filter(item => {
                const itemId = item.getAttribute('data-item');
                const input = document.querySelector(`input[type="number"][name="${itemId}"]`);
                return input && input.value && parseInt(input.value, 10) > 0;
            }).length;
            
            const completados = completadosRadio + completadosCantidad;
            
            // Calcular porcentaje
            const porcentaje = totalItems > 0 ? Math.round((completados / totalItems) * 100) : 0;
            
            // Actualizar barra de progreso y mensaje
            document.getElementById('progress-bar').style.width = `${porcentaje}%`;
            document.getElementById('status-message').textContent = `Completado: ${porcentaje}% (${completados}/${totalItems} items)`;
            
            // Mostrar barra de estado si hay algún progreso o si estamos en modo parcial
            if (completados > 0 || modoInspeccionParcial) {
                document.getElementById('status-bar').classList.remove('hidden');
            } else if (completados === 0 && !modoInspeccionParcial) {
                document.getElementById('status-bar').classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Cargar fecha y hora actual
            const fechaHoraInput = document.getElementById('fechaHora');
            if (fechaHoraInput) {
                const now = new Date();
                // Ajustar la zona horaria local para el formato datetime-local
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                fechaHoraInput.value = now.toISOString().slice(0, 16);
            }

            // Botón para modo de inspección parcial
            const btnModoInspeccionParcial = document.getElementById('btnModoInspeccionParcial');
            if (btnModoInspeccionParcial) {
                btnModoInspeccionParcial.addEventListener('click', function() {
                    modoInspeccionParcial = !modoInspeccionParcial;
                    
                    // Actualizar el estado visual del botón
                    if (modoInspeccionParcial) {
                        this.textContent = 'MODO COMPLETO (Todas las secciones)';
                        this.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                        this.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    } else {
                        this.textContent = 'MODO PARCIAL (Solo secciones 5, 6 y 7)';
                        this.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                        this.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    }
                    
                    // Aplicar el modo de inspección
                    aplicarModoInspeccion();
                });
            }
            
            // Función para aplicar el modo de inspección
            function aplicarModoInspeccion() {
                // IDs de las secciones que queremos mostrar en el modo parcial
                const seccionesParcialesIds = ['elementosSeguridad', 'elementosEPP', 'elementosCargas'];
                
                // Recorrer todas las secciones
                datosFormulario.secciones.forEach(seccion => {
                    const seccionContainer = document.querySelector(`.section-container[data-id="${seccion.id}"]`);
                    
                    if (seccionContainer) {
                        if (modoInspeccionParcial) {
                            // En modo parcial: mostrar solo las secciones 5, 6 y 7
                            const esMostrar = seccionesParcialesIds.includes(seccion.id);
                            seccionContainer.style.display = esMostrar ? 'block' : 'none';
                            
                            // Hacer los inputs requeridos o no según corresponda
                            seccion.items.forEach(item => {
                                const inputs = document.querySelectorAll(`[name="${item.id}"]`);
                                inputs.forEach(input => {
                                    if (esMostrar) {
                                        // Si la sección se muestra, mantener el required
                                        if (!input.hasAttribute('data-required-original')) {
                                            input.setAttribute('data-required-original', input.required);
                                        }
                                    } else {
                                        // Si la sección se oculta, quitar el required
                                        if (!input.hasAttribute('data-required-original')) {
                                            input.setAttribute('data-required-original', input.required);
                                        }
                                        input.required = false;
                                    }
                                });
                            });
                        } else {
                            // En modo completo: mostrar todas las secciones
                            seccionContainer.style.display = 'block';
                            
                            // Restaurar el estado original de required
                            seccion.items.forEach(item => {
                                const inputs = document.querySelectorAll(`[name="${item.id}"]`);
                                inputs.forEach(input => {
                                    if (input.hasAttribute('data-required-original')) {
                                        input.required = input.getAttribute('data-required-original') === 'true';
                                    }
                                });
                            });
                        }
                    }
                });
                
                // Recalcular progreso visible
                calcularProgresoVisible();
                // Actualizar el progreso
                actualizarProgreso();
            }
            
            // Función para calcular el progreso solo de secciones visibles
            function calcularProgresoVisible() {
                datosFormulario.secciones.forEach(seccion => {
                    const seccionContainer = document.querySelector(`.section-container[data-id="${seccion.id}"]`);
                    if (seccionContainer && seccionContainer.style.display !== 'none') {
                        actualizarProgresoSeccion(seccion.id);
                    }
                });
            }

            // Generar secciones con los datos predeterminados
            generarSecciones(datosFormulario);
            
            // Configurar secciones desplegables
            configurarSecciones();
            
            // Configurar inputs radio para mejor UX móvil
            configurarRadioInputs();

            // Convertir a mayúsculas en campos específicos
            const uppercaseInputs = ['chofer', 'tractor', 'semi'];
            uppercaseInputs.forEach(id => {
                const inputElement = document.getElementById(id);
                if (inputElement) {
                    inputElement.addEventListener('input', function() {
                        this.value = this.value.toUpperCase();
                    });
                }
            });
            
            // Para cargar desde un JSON externo, descomentar:
            // cargarDatosJSON('ruta/a/tu/datos.json');
            
            // Función para expandir todas las secciones
            document.getElementById('btnExpandirTodo').addEventListener('click', function() {
                const todosLosHeaders = document.querySelectorAll('.section-header');
                const todasLasSecciones = document.querySelectorAll('.section-content');
                
                // Verificar si todas están abiertas o no
                const todasAbiertas = Array.from(todasLasSecciones).every(seccion => !seccion.classList.contains('hidden'));
                
                if (todasAbiertas) {
                    // Cerrar todas
                    this.textContent = 'Expandir Todo';
                    todasLasSecciones.forEach(seccion => {
                        seccion.classList.add('hidden');
                    });
                    document.querySelectorAll('.toggle-icon').forEach(icon => {
                        icon.textContent = '+';
                    });
                } else {
                    // Abrir todas
                    this.textContent = 'Contraer Todo';
                    todasLasSecciones.forEach(seccion => {
                        seccion.classList.remove('hidden');
                    });
                    document.querySelectorAll('.toggle-icon').forEach(icon => {
                        icon.textContent = '-';
                    });
                }
            });

            // Función para Pantalla Completa
            const btnPantallaCompleta = document.getElementById('btnPantallaCompleta');
            const svgExpand = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>`;
            const svgContract = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l-5 5m0 0l5-5m-5 5v-4m5 4h-4M4 10l5-5m0 0l-5 5m5-5v4M4 4h4m10 10l5 5m0 0l-5-5m5 5v-4m-5 4h4m-4-6l-5-5m0 0l5 5m-5-5v4m5-4h4" /></svg>`;

            if (btnPantallaCompleta) {
                btnPantallaCompleta.addEventListener('click', function() {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(err => {
                            alert(`Error al intentar entrar en pantalla completa: ${err.message} (${err.name})`);
                        });
                        this.innerHTML = svgContract; // Cambiar a icono de contraer
                        this.title = 'Salir Pantalla Completa';
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                            this.innerHTML = svgExpand; // Cambiar a icono de expandir
                            this.title = 'Pantalla Completa';
                        }
                    }
                });
            
                // Actualizar el icono del botón si se sale de pantalla completa con ESC
                document.addEventListener('fullscreenchange', () => {
                    if (!document.fullscreenElement) {
                        btnPantallaCompleta.innerHTML = svgExpand; 
                        btnPantallaCompleta.title = 'Pantalla Completa';
                    }
                });
            }

            // Validar formulario antes de enviar
            const form = document.getElementById('formVehiculo');
            const submitButton = form.querySelector('button[type="submit"]'); // Obtener el botón de guardar
            const modal = document.getElementById('modalGuardar');
            const btnGuardarCompartir = document.getElementById('btnGuardarCompartir');
            const btnGuardarAbrir = document.getElementById('btnGuardarAbrir');
            const btnGuardarDescargar = document.getElementById('btnGuardarDescargar');
            const btnCancelarModal = document.getElementById('btnCancelarModal');
            let accionPDFSeleccionada = 'download'; // Por defecto descarga
            
            // Modificar el listener del botón de submit original
            submitButton.addEventListener('click', function(e) {
                e.preventDefault(); // Prevenir envío automático
                // Mostrar el modal en lugar de enviar
                modal.classList.remove('hidden'); 
            });

            // Función para cerrar el modal
            function cerrarModal() {
                modal.classList.add('hidden');
            }

            // Listener para cancelar
            btnCancelarModal.addEventListener('click', cerrarModal);

            // Función para manejar el proceso de guardado real
            function procederConGuardado() {
                cerrarModal(); // Ocultar modal

                // Deshabilitar botón para evitar duplicados
                submitButton.disabled = true;
                submitButton.textContent = 'Guardando...'; // Cambiar texto del botón
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');

                // Validar que todos los campos requeridos estén completos
                const requiredInputs = document.querySelectorAll('[required]');
                let isValid = true;
                let seccionesIncompletas = new Set();
                
                requiredInputs.forEach(input => {
                    // Solo validar campos que están visibles (para modo parcial)
                    const seccionElement = input.closest('.section-container');
                    if (seccionElement && seccionElement.style.display === 'none') {
                        return; // Saltar validación para elementos en secciones ocultas
                    }
                    
                    if (input.type === 'radio') {
                        const name = input.name;
                        const checked = document.querySelector(`input[name="${name}"]:checked`);
                        if (!checked) {
                            isValid = false;
                            const seccionElement = input.closest('.section-content');
                            if (seccionElement) seccionesIncompletas.add(seccionElement.id);
                            const row = document.querySelector(`[data-item="${name}"]`);
                            if (row) row.classList.add('bg-red-50');
                        } else {
                            const row = document.querySelector(`[data-item="${name}"]`);
                            if (row) row.classList.remove('bg-red-50');
                        }
                    } else if (!input.value && input.value !== "0") { // Permitir 0 en campos numéricos
                        isValid = false;
                        input.classList.add('border-red-500', 'bg-red-50');
                    } else {
                        input.classList.remove('border-red-500', 'bg-red-50');
                    }
                });
                
                if (!isValid) {
                    seccionesIncompletas.forEach(seccionId => {
                        const seccion = document.getElementById(seccionId);
                        if (seccion.classList.contains('hidden')) {
                            const header = document.querySelector(`.section-header[data-section="${seccionId}"]`);
                            header.click();
                        }
                    });
                    const elementosFaltantes = Array.from(requiredInputs).filter(input => {
                        // Solo contar elementos en secciones visibles
                        const seccionElement = input.closest('.section-container');
                        return seccionElement && seccionElement.style.display !== 'none' && !input.validity.valid;
                    }).length;
                    
                    alert(`Por favor complete todos los campos requeridos. Faltan ${elementosFaltantes} elementos.`);
                    // Habilitar el botón si la validación falla
                    submitButton.disabled = false;
                    submitButton.textContent = 'Guardar Inspección';
                    submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    return;
                }
                
                // Crear objeto JSON con la estructura deseada
                const jsonDataToSend = {
                    fechaHora: form.elements.fechaHora.value,
                    chofer: form.elements.chofer.value,
                    tractor: form.elements.tractor.value,
                    semi: form.elements.semi.value,
                    // Agrega aquí kmCamion y semi2 si los añadiste al HTML
                    // kmCamion: form.elements.kmCamion?.value || '', 
                    // semi2: form.elements.semi2?.value || '',
                    modoParcial: modoInspeccionParcial, // Indicar si se usó modo parcial 
                    secciones: {}
                };

                // Determinar qué secciones incluir según el modo actual
                const seccionesAIncluir = modoInspeccionParcial
                    ? datosFormulario.secciones.filter(seccion => 
                        ['elementosSeguridad', 'elementosEPP', 'elementosCargas'].includes(seccion.id))
                    : datosFormulario.secciones;

                seccionesAIncluir.forEach(seccion => {
                    jsonDataToSend.secciones[seccion.id] = {};
                    seccion.items.forEach(item => {
                        const observacionInput = form.elements[`obs_${item.id}`];
                        const observacion = observacionInput ? observacionInput.value : '';

                        if (seccion.tipo === 'check') {
                            const radioChecked = form.querySelector(`input[name="${item.id}"]:checked`);
                            const valor = radioChecked ? radioChecked.value : '';
                            jsonDataToSend.secciones[seccion.id][item.id] = {
                                valor: valor,
                                observacion: observacion
                            };
                        } else if (seccion.tipo === 'cantidad') {
                            const cantidadInput = form.elements[item.id];
                            const cantidadStr = cantidadInput ? cantidadInput.value : '0';
                            // Convertir la cantidad a número
                            const cantidadNum = parseInt(cantidadStr, 10);
                            // Usar 0 si la conversión falla (aunque type=number debería prevenirlo)
                            const cantidadFinal = isNaN(cantidadNum) ? 0 : cantidadNum; 
                            jsonDataToSend.secciones[seccion.id][item.id] = {
                                cantidad: cantidadFinal, // Usar el valor numérico
                                observacion: observacion
                            };
                        }
                    });
                });
                
                const jsonDataString = JSON.stringify(jsonDataToSend);
                console.log('Datos a enviar (estructurados):', jsonDataString);
                
                // Salir de pantalla completa si está activa
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }

                // Enviar datos por POST
                fetch('https://hook.us2.make.com/s3uhwkuujk4xld7nnv96fcrye09gzn5z', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: jsonDataString // Enviar el JSON estructurado
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP ${response.status} - ${response.statusText}`);
                    }
                    return response.text(); 
                })
                .then(text => {
                    console.log("Respuesta cruda del servidor (texto):", text);
                    // Verificar si la respuesta es exactamente "Accepted"
                    if (text.trim().toLowerCase() === "accepted") { // Usar toLowerCase para ser más flexible
                        // --- Éxito --- 
                        console.log('Respuesta del servidor interpretada como éxito ("Accepted").');
                        // Generar PDF después de guardar exitosamente con la acción seleccionada
                        generarPDF(accionPDFSeleccionada);
                        alert('Inspección guardada correctamente');
                        // Habilitar el botón después de éxito
                        submitButton.disabled = false;
                        submitButton.textContent = 'Guardar Inspección';
                        submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        // --- Fin Éxito ---
                    } else {
                        // Si la respuesta es 200 OK pero no es "Accepted", tratar como error
                        console.error("Respuesta inesperada del servidor (se esperaba 'Accepted'):", text);
                        throw new Error('Respuesta inesperada del servidor.');
                    }
                })
                .catch(error => {
                    // Captura errores de red, errores HTTP (4xx, 5xx), y la respuesta inesperada
                    alert(`Error al guardar o procesar respuesta: ${error.message}`);
                    console.error('Error detallado:', error);
                    // Salir de pantalla completa si está activa (también en caso de error)
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                    // Habilitar el botón después de error
                    submitButton.disabled = false;
                    submitButton.textContent = 'Guardar Inspección';
                    submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                });
            }

            // Listeners para los botones del modal
            btnGuardarCompartir.addEventListener('click', () => {
                accionPDFSeleccionada = 'share';
                procederConGuardado();
            });
            btnGuardarAbrir.addEventListener('click', () => {
                accionPDFSeleccionada = 'open';
                procederConGuardado();
            });
            btnGuardarDescargar.addEventListener('click', () => {
                accionPDFSeleccionada = 'download';
                procederConGuardado();
            });

            // Mantener todas las secciones recogidas inicialmente
            // (No abrir automáticamente la primera sección)
            
            // Inicializar contadores de progreso
            datosFormulario.secciones.forEach(seccion => {
                actualizarProgresoSeccion(seccion.id);
            });
            actualizarProgreso();
        });

        // Función para añadir una nueva sección al formulario
        function agregarSeccion(seccionData) {
            // Añadir la nueva sección al objeto de datos
            datosFormulario.secciones.push(seccionData);
            
            // Regenerar las secciones
            generarSecciones(datosFormulario);
            
            // Reconfigurar eventos de las secciones
            configurarSecciones();
            configurarRadioInputs();
            actualizarProgreso();
        }

        // Función para generar PDF
        function generarPDF(accion = 'download') {
            // Obtener los datos del formulario
            const formData = new FormData(document.getElementById('formVehiculo'));
            const formDataObj = {};
            formData.forEach((value, key) => {
                formDataObj[key] = value;
            });

            // Determinar qué secciones incluir según el modo actual
            const seccionesAIncluir = modoInspeccionParcial
                ? datosFormulario.secciones.filter(seccion => 
                    ['elementosSeguridad', 'elementosEPP', 'elementosCargas'].includes(seccion.id))
                : datosFormulario.secciones;
            
            // Definir el contenido del PDF
            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [40, 40, 40, 40],
                content: [
                    // Encabezado estilo imagen
                    {
                        table: {
                            widths: ['25%', '50%', '25%'],
                            body: [
                                [
                                    // Celda para el logo (requiere imagen base64)
                                    { text: 'TRANSPORTE IBARRA S.A.', style: 'header', alignment: 'center', margin: [0, 10, 0, 10] }, 
                                    { text: 'CHECK DE VERIFICACIÓN DE VEHÍCULO', style: 'subheader', alignment: 'center', margin: [0, 10, 0, 10] },
                                    { text: 'FORMULARIO A1', style: 'formNumber', alignment: 'center', margin: [0, 10, 0, 10] }
                                ]
                            ]
                        },
                        layout: 'headerLines', // Estilo de borde simple
                        margin: [0, 0, 0, 10]
                    },
                    // Modo de inspección
                    modoInspeccionParcial ? {
                        text: 'MODO DE INSPECCIÓN PARCIAL (Solo Secciones 5, 6 y 7)',
                        style: 'modoInspeccion',
                        alignment: 'center',
                        margin: [0, 5, 0, 15]
                    } : null,
                    // Información básica estilo imagen
                    {
                        table: {
                            widths: ['auto', '*', 'auto', '*'],
                            body: [
                                [
                                    { text: 'FECHA', style: 'tableHeader' },
                                    { text: formDataObj.fechaHora ? new Date(formDataObj.fechaHora).toLocaleDateString() : '', style: 'tableCell' }, // Formatear fecha
                                    { text: 'CHOFER', style: 'tableHeader' },
                                    { text: formDataObj.chofer || '', style: 'tableCell' }
                                ],
                                [
                                    { text: 'TRACTOR', style: 'tableHeader' },
                                    { text: formDataObj.tractor || '', style: 'tableCell' },
                                    { text: 'SEMI', style: 'tableHeader' },
                                    { text: formDataObj.semi || '', style: 'tableCell' }
                                ],
                            ]
                        },
                        layout: 'lightHorizontalLines', // Estilo de borde simple
                        margin: [0, 0, 0, 10]
                    },
                    // Secciones - Filtrado según el modo seleccionado
                    ...seccionesAIncluir.map(seccion => {
                        const rows = seccion.items.map(item => {
                            if (seccion.tipo === 'check') {
                                const radioValue = formDataObj[item.id] || '';
                                return [
                                    { text: item.nombre, style: 'tableCell' },
                                    { text: radioValue === 'si' ? 'X' : '', style: 'tableCell', alignment: 'center' },
                                    { text: radioValue === 'no' ? 'X' : '', style: 'tableCell', alignment: 'center' },
                                    { text: radioValue === 'na' ? 'X' : '', style: 'tableCell', alignment: 'center' },
                                    { text: formDataObj[`obs_${item.id}`] || '', style: 'tableCell' }
                                ];
                            } else {
                                return [
                                    { text: item.nombre, style: 'tableCell' },
                                    { text: formDataObj[item.id] || '0', style: 'tableCell', alignment: 'center' },
                                    { text: formDataObj[`obs_${item.id}`] || '', style: 'tableCell' }
                                ];
                            }
                        });

                        return [
                            {
                                text: seccion.titulo,
                                style: 'sectionHeader',
                                margin: [0, 20, 0, 10]
                            },
                            {
                                table: {
                                    widths: seccion.tipo === 'check' ? ['40%', '10%', '10%', '10%', '30%'] : ['50%', '20%', '30%'],
                                    headerRows: 1,
                                    body: [
                                        seccion.tipo === 'check' 
                                            ? [
                                                { text: 'ITEMS A CONTROLAR', style: 'tableHeader' },
                                                { text: 'SI', style: 'tableHeader', alignment: 'center' },
                                                { text: 'NO', style: 'tableHeader', alignment: 'center' },
                                                { text: 'N/A', style: 'tableHeader', alignment: 'center' },
                                                { text: 'OBSERVACIONES', style: 'tableHeader' }
                                            ]
                                            : [
                                                { text: 'ITEMS A CONTROLAR', style: 'tableHeader' },
                                                { text: 'CANTIDAD', style: 'tableHeader', alignment: 'center' },
                                                { text: 'OBSERVACIONES', style: 'tableHeader' }
                                            ],
                                        ...rows
                                    ]
                                },
                                layout: {
                                    hLineWidth: function(i, node) { return 1; },
                                    vLineWidth: function(i, node) { return 1; },
                                    hLineColor: function(i, node) { return '#d1d5db'; },
                                    vLineColor: function(i, node) { return '#d1d5db'; }
                                }
                            }
                        ];
                    })
                ],
                styles: {
                    header: {
                        fontSize: 16,
                        bold: true
                    },
                    subheader: {
                        fontSize: 14,
                        bold: true
                    },
                    formNumber: {
                        fontSize: 14,
                        bold: true
                    },
                    modoInspeccion: {
                        fontSize: 12,
                        bold: true,
                        color: '#d97706',
                        background: '#fef3c7'
                    },
                    sectionHeader: {
                        fontSize: 12,
                        bold: true,
                        color: '#1f2937'
                    },
                    tableHeader: {
                        fontSize: 10,
                        bold: true,
                        fillColor: '#f3f4f6',
                        color: '#1f2937'
                    },
                    tableCell: {
                        fontSize: 10,
                        color: '#1f2937'
                    }
                }
            };

            // Generar nombre de archivo dinámico
            const fechaHora = formDataObj.fechaHora ? new Date(formDataObj.fechaHora) : new Date();
            const year = fechaHora.getFullYear();
            const month = String(fechaHora.getMonth() + 1).padStart(2, '0'); // Meses son 0-indexados
            const day = String(fechaHora.getDate()).padStart(2, '0');
            const fechaFormateada = `${year}${month}${day}`;
            const chofer = formDataObj.chofer || 'SIN_CHOFER';
            const tractor = formDataObj.tractor || 'SIN_TRACTOR';
            const semi = formDataObj.semi || 'SIN_SEMI';
            const nombreArchivo = `${fechaFormateada} - ${chofer} - ${tractor} - ${semi}.pdf`;

            // Generar y realizar acción sobre el PDF
            const pdfDocGenerator = pdfMake.createPdf(docDefinition);

            if (accion === 'share' && navigator.share) {
                pdfDocGenerator.getBlob((blob) => {
                    const file = new File([blob], nombreArchivo, { type: 'application/pdf' });
                    navigator.share({
                        title: nombreArchivo,
                        text: `Check de Vehículo - ${chofer} - ${fechaFormateada}`,
                        files: [file]
                    })
                    .then(() => console.log('Compartido con éxito'))
                    .catch((error) => {
                        console.error('Error al compartir:', error);
                        // Fallback a descarga si falla el share
                        pdfDocGenerator.download(nombreArchivo);
                        alert('No se pudo compartir, se descargará el PDF.');
                    });
                });
            } else if (accion === 'open') {
                pdfDocGenerator.open({}, window.open('', '_blank'));
            } else { // default o share no disponible
                pdfDocGenerator.download(nombreArchivo);
            }
        }
    </script>
</body>
</html> 