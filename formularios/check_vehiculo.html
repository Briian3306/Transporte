<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check de Verificación de Vehículo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <style>
        @media print {
            .no-print {
                display: none;
            }
            button {
                display: none;
            }
        }
        /* Estilo para input radio personalizado más grande y accesible en móviles */
        .radio-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }
        .radio-container input[type="radio"] {
            transform: scale(1.5);
            margin: 0;
            cursor: pointer;
        }
        /* Mejora la experiencia táctil */
        .touch-target {
            min-height: 44px;
        }
        @media (max-width: 640px) {
            .table-scroll {
                max-height: 70vh;
                overflow-y: auto;
            }
            .touch-target {
                min-height: 48px;
            }
            .radio-container input[type="radio"] {
                transform: scale(1.8);
            }
        }
        /* Espacio para los botones flotantes en móvil */
        .content-wrapper {
            padding-bottom: 120px; /* Espacio para los botones flotantes en móvil */
        }
        @media (min-width: 768px) {
            .content-wrapper {
                padding-bottom: 0; /* Sin padding en desktop */
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-4">
    <form id="formVehiculo" method="post" action="#" class="max-w-6xl mx-auto content-wrapper">
        <div class="bg-white shadow-md rounded-lg overflow-hidden border border-gray-300">
            <!-- Encabezado - Responsive -->
            <div class="flex flex-col md:flex-row border-b border-gray-300">
                <div class="w-full md:w-1/5 p-3 md:p-4 border-b md:border-b-0 md:border-r border-gray-300 flex flex-col items-center justify-center">
                    <div class="text-center mt-2 font-semibold">TRANSPORTE IBARRA S.A.</div>
                </div>
                <div class="w-full md:w-3/5 p-3 md:p-4 border-b md:border-b-0 md:border-r border-gray-300 flex items-center justify-center">
                    <h1 class="text-lg md:text-xl font-bold text-center">CHECK DE VERIFICACIÓN DE VEHÍCULO</h1>
                </div>
                <div class="w-full md:w-1/5 p-3 md:p-4 flex items-center justify-center">
                    <div class="text-lg md:text-xl font-bold">FORMULARIO A1</div>
                </div>
            </div>

            <!-- Información básica - Responsive -->
            <div class="flex flex-col md:flex-row border-b border-gray-300">
                <div class="w-full md:w-1/4 p-2 md:p-4 bg-gray-50 font-bold flex items-center justify-center md:justify-start border-b md:border-b-0 md:border-r border-gray-300">FECHA Y HORA</div>
                <div class="w-full md:w-1/4 p-2 md:p-4 border-b md:border-b-0 md:border-r border-gray-300">
                    <input type="datetime-local" name="fechaHora" id="fechaHora" required 
                          class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 touch-target">
                </div>
                <div class="w-full md:w-1/4 p-2 md:p-4 bg-gray-50 font-bold flex items-center justify-center md:justify-start border-b md:border-b-0 md:border-r border-gray-300">CHOFER</div>
                <div class="w-full md:w-1/4 p-2 md:p-4 relative">
                    <input type="text" name="chofer" id="chofer" required 
                          class="w-full p-2 pr-10 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 touch-target">
                    <button type="button" id="btnCargarDatos" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-500 transition-colors" title="Cargar datos desde sistema">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex flex-col md:flex-row border-b border-gray-300">
                <div class="w-full md:w-1/4 p-2 md:p-4 bg-gray-50 font-bold flex items-center justify-center md:justify-start border-b md:border-b-0 md:border-r border-gray-300">TRACTOR</div>
                <div class="w-full md:w-1/4 p-2 md:p-4 border-b md:border-b-0 md:border-r border-gray-300">
                    <input type="text" name="tractor" id="tractor" required 
                          class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 touch-target">
                </div>
                <div class="w-full md:w-1/4 p-2 md:p-4 bg-gray-50 font-bold flex items-center justify-center md:justify-start border-b md:border-b-0 md:border-r border-gray-300">SEMI</div>
                <div class="w-full md:w-1/4 p-2 md:p-4">
                    <input type="text" name="semi" id="semi" required 
                          class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 touch-target">
                </div>
            </div>

            <!-- Título de sección -->
            <div class="p-3 md:p-4 text-center font-bold bg-gray-200 border-b border-gray-300">
                INSPECCIÓN VEHICULAR
            </div>

            <!-- Contenedor dinámico para las secciones -->
            <div id="secciones-container">
                <!-- Las secciones se generarán dinámicamente desde el JSON -->
            </div>
            
            <!-- Mensaje de estado de completado -->
            <div id="status-bar" class="p-3 text-center bg-gray-100 border-t border-gray-300 hidden">
                <span id="status-message" class="font-medium"></span>
                <div class="w-full bg-gray-300 rounded-full h-4 mt-2">
                    <div id="progress-bar" class="bg-green-600 h-4 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- Selector de modo de inspección -->
            <div class="p-3 md:p-4 text-center bg-yellow-100 border-t border-gray-300">
                <button type="button" id="btnModoInspeccion" class="w-full md:w-auto bg-gray-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-gray-700 transition-colors touch-target">
                    MODO COMPLETO (Todas las secciones)
                </button>
            </div>
        </div>
        
        <!-- Botones flotantes para móvil y fijos para desktop -->
        <div class="fixed bottom-0 left-0 w-full p-3 bg-white border-t border-gray-300 shadow-lg md:shadow-none md:static md:mt-6 md:flex md:justify-between no-print z-10">
            <button type="submit" class="w-full md:w-auto bg-green-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-green-700 transition-colors mb-2 md:mb-0 touch-target">
                Guardar Inspección
            </button>
            <div class="flex space-x-2 w-full md:w-auto">
                <button type="button" id="btnExpandirTodo" class="w-1/2 md:w-auto bg-gray-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-gray-700 transition-colors touch-target">
                    Expandir Todo
                </button>
                <button type="button" id="btnPantallaCompleta" class="w-1/2 md:w-auto bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition-colors touch-target" title="Pantalla Completa">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                    </svg>
                </button>
            </div>
        </div>
    </form>

    <!-- Página de Selección de Modo -->
    <div id="modalSeleccionModo" class="fixed inset-0 bg-gradient-to-br from-blue-50 to-indigo-100 h-full w-full overflow-y-auto z-50">
        <div class="min-h-screen flex flex-col">
            <!-- Encabezado -->
            <div class="bg-white shadow-sm border-b border-gray-200">
                <div class="max-w-4xl mx-auto px-4 py-6">
                    <div class="text-center">
                        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">TRANSPORTE IBARRA S.A.</h1>
                        <h2 class="text-xl md:text-2xl font-semibold text-gray-700">Check de Verificación de Vehículo</h2>
                    </div>
                </div>
            </div>

            <!-- Contenido Principal -->
            <div class="flex-1 flex items-center justify-center p-4 md:p-8">
                <div class="max-w-4xl w-full">
                    <div class="text-center mb-8 md:mb-12">
                        <h3 class="text-2xl md:text-3xl font-bold text-gray-900 mb-4">Seleccionar Modo de Inspección</h3>
                        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                            Elige el tipo de inspección que deseas realizar según tus necesidades operativas
                        </p>
                    </div>
                    
                    <!-- Grid de opciones -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
                        <!-- Modo Diario -->
                        <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden border-2 border-transparent hover:border-blue-200">
                            <button id="btnSeleccionarDiario" class="w-full p-8 text-left bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white transition-all duration-300 transform hover:scale-105">
                                <div class="text-center">
                                    <div class="text-4xl mb-4">🔧</div>
                                    <h4 class="text-xl font-bold mb-3">MODO DIARIO</h4>
                                    <div class="bg-white bg-opacity-20 rounded-lg p-3 mb-4">
                                        <p class="text-sm font-semibold opacity-90">Secciones 1, 2, 3 y 4</p>
                                    </div>
                                    <div class="text-sm opacity-90 leading-relaxed">
                                        <p>• Sistema eléctrico</p>
                                        <p>• Tractor</p>
                                        <p>• Semirremolque</p>
                                        <p>• General</p>
                                    </div>
                                </div>
                            </button>
                            <div class="p-4 bg-blue-50">
                                <p class="text-xs text-blue-700 text-center">Ideal para inspecciones rutinarias diarias</p>
                            </div>
                        </div>
                        
                        <!-- Modo Parcial -->
                        <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden border-2 border-transparent hover:border-green-200">
                            <button id="btnSeleccionarParcial" class="w-full p-8 text-left bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white transition-all duration-300 transform hover:scale-105">
                                <div class="text-center">
                                    <div class="text-4xl mb-4">🛡️</div>
                                    <h4 class="text-xl font-bold mb-3">MODO PARCIAL</h4>
                                    <div class="bg-white bg-opacity-20 rounded-lg p-3 mb-4">
                                        <p class="text-sm font-semibold opacity-90">Secciones 5, 6 y 7</p>
                                    </div>
                                    <div class="text-sm opacity-90 leading-relaxed">
                                        <p>• Elementos de seguridad</p>
                                        <p>• Elementos de EPP</p>
                                        <p>• Elementos de cargas</p>
                                    </div>
                                </div>
                            </button>
                            <div class="p-4 bg-green-50">
                                <p class="text-xs text-green-700 text-center">Enfoque en seguridad y manejo de cargas</p>
                            </div>
                        </div>
                        
                        <!-- Modo Completo -->
                        <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden border-2 border-transparent hover:border-gray-300">
                            <button id="btnSeleccionarCompleto" class="w-full p-8 text-left bg-gradient-to-br from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white transition-all duration-300 transform hover:scale-105">
                                <div class="text-center">
                                    <div class="text-4xl mb-4">📋</div>
                                    <h4 class="text-xl font-bold mb-3">MODO COMPLETO</h4>
                                    <div class="bg-white bg-opacity-20 rounded-lg p-3 mb-4">
                                        <p class="text-sm font-semibold opacity-90">Todas las secciones</p>
                                    </div>
                                    <div class="text-sm opacity-90 leading-relaxed">
                                        <p>• Inspección integral</p>
                                        <p>• Verificación exhaustiva</p>
                                        <p>• Control total del vehículo</p>
                                    </div>
                                </div>
                            </button>
                            <div class="p-4 bg-gray-50">
                                <p class="text-xs text-gray-700 text-center">Inspección completa y detallada</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información adicional -->
                    <div class="mt-8 md:mt-12 text-center">
                        <div class="bg-white rounded-xl shadow-sm p-6 max-w-2xl mx-auto">
                            <div class="flex items-center justify-center mb-3">
                                <svg class="w-6 h-6 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h4 class="text-lg font-semibold text-gray-900">Información</h4>
                            </div>
                            <p class="text-gray-600">
                                Puedes cambiar el modo de inspección en cualquier momento usando el botón correspondiente en el formulario.
                                Cada modo está optimizado para diferentes tipos de verificación según tus necesidades operativas.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pie de página -->
            <div class="bg-white border-t border-gray-200 py-4">
                <div class="max-w-4xl mx-auto px-4 text-center">
                    <p class="text-sm text-gray-500">© 2025 Transporte Ibarra S.A. - Sistema de Control Vehicular</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Carga de Datos -->
    <div id="modalCargaDatos" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 max-w-4xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Seleccionar Unidad</h3>
                <button id="btnCerrarModalDatos" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Filtros -->
            <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="filtroChoferModal" class="block text-sm font-medium text-gray-700 mb-2">Filtrar por apellido del chofer</label>
                    <input 
                        type="text" 
                        id="filtroChoferModal" 
                        placeholder="Buscar por apellido..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    >
                </div>
                <div>
                    <label for="filtroPatenteModal" class="block text-sm font-medium text-gray-700 mb-2">Filtrar por patente del camión</label>
                    <input 
                        type="text" 
                        id="filtroPatenteModal" 
                        placeholder="Buscar por patente..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    >
                </div>
            </div>
            
            <!-- Loading -->
            <div id="cargaDatosLoading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="mt-2 text-sm text-gray-600">Cargando unidades...</p>
            </div>
            
            <!-- Tabla -->
            <div id="tablaDatosContainer" class="hidden flex-1 overflow-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chofer</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Camión</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Semi 1</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Semi 2</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="tablaDatosBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            
            <!-- Error -->
            <div id="errorCargaDatos" class="hidden text-center py-8">
                <div class="text-red-500 mb-2">
                    <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <p class="text-sm text-gray-600">Error al cargar los datos. Verifica tu conexión e intenta nuevamente.</p>
                <button id="btnRetryCargarDatos" class="mt-3 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">
                    Reintentar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Opciones de Guardado -->
    <div id="modalGuardar" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-11/12 sm:w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Guardar y Generar PDF</h3>
                <div class="mt-2 px-7 py-3 space-y-3">
                    <p class="text-sm text-gray-500">
                        Elige qué hacer con el PDF después de guardar la inspección:
                    </p>
                    <button id="btnGuardarCompartir" class="w-full block bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Guardar y Compartir
                    </button>
                    <button id="btnGuardarAbrir" class="w-full block bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                        Guardar y Abrir PDF
                    </button>
                    <button id="btnGuardarDescargar" class="w-full block bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                        Solo Guardar (Descargar PDF)
                    </button>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="btnCancelarModal" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Datos para generar las secciones del formulario
        const datosFormulario = {
            secciones: [
                {
                    id: "sistemaElectrico",
                    titulo: "1-SISTEMA ELECTRICO",
                    tipo: "check",
                    items: [
                        { id: "lucesCompleto", nombre: "Control de Luces completo" },
                        { id: "limpiaparabrisas", nombre: "Limpiaparabrisas" },
                        { id: "alarmaRetroceso", nombre: "Alarma de retroceso" },
                        { id: "bocina", nombre: "Bocina" },
                        { id: "tableroInstrumentos", nombre: "Tablero/instrumentos" },
                        { id: "desempanador", nombre: "Desempañador" },
                        { id: "tacografo", nombre: "Tacografo" },
                        { id: "vigia", nombre: "Vigia" }
                    ]
                },
                {
                    id: "seccionTractor",
                    titulo: "2-TRACTOR",
                    tipo: "check",
                    items: [
                        { id: "fluidos", nombre: "Fluidos" },
                        { id: "presionAireFreno", nombre: "Precion de aire / Sist. Freno" },
                        { id: "puertasAsientos", nombre: "Puertas y asientos" },
                        { id: "manijasTrabasAlzavidrios", nombre: "Manijas, alzavidrios" },
                        { id: "estribos", nombre: "Estribos" },
                        { id: "espejosRetrovisores", nombre: "Espejos retrovisores" },
                        { id: "parabrisasLuneta", nombre: "Parabrisas/luneta" },
                        { id: "cinturonSeguridad", nombre: "Cinturon de seguridad" },
                        { id: "calefaccionAire", nombre: "Calefaccion/ Aire Acond." },
                        { id: "guardabarroTractor", nombre: "Guardabarro" }, 
                        { id: "paragolpesTractor", nombre: "Paragolpes completos" }, 
                        { id: "tanqueCombustible", nombre: "Tanque de combustible" },
                        { id: "cubiertasTractor", nombre: "Cubiertas" }, 
                        { id: "cubiertaAuxilioTractor", nombre: "Cubierta de Auxilio" }, 
                        { id: "gatoHidraulico", nombre: "Gato hidraulico" },
                        { id: "llaveRueda", nombre: "Llave de rueda" },
                        { id: "manijaCabina", nombre: "Manija p/cabina" },
                        { id: "satelital", nombre: "Sirena y puertas satelital" }
                    ]
                },
                {
                    id: "semirremolque",
                    titulo: "3-SEMIRREMOLQUE",
                    tipo: "check",
                    items: [
                        { id: "parantes", nombre: "Parantes" },
                        { id: "barandas", nombre: "Barandas" },
                        { id: "compuertaTrasera", nombre: "Compuerta trasera" },
                        { id: "paragolpesSemi", nombre: "Paragolpes completos" }, 
                        { id: "guardabarroSemi", nombre: "Guardabarro" }, 
                        { id: "alarmaVuelco", nombre: "Alarma de vuelco" },
                        { id: "cubiertasSemi", nombre: "Cubiertas" }, 
                        { id: "cubiertaAuxilioSemi", nombre: "Cubierta de Auxilio" } 
                    ]
                },
                {
                    id: "general",
                    titulo: "4-GENERAL",
                    tipo: "check",
                    items: [
                        { id: "danos", nombre: "Daños" },
                        { id: "perdidasFluidos", nombre: "Perdidas de Fluidos" },
                        { id: "frenos", nombre: "Frenos" },
                        { id: "chapasPatentes", nombre: "Chapas patentes" },
                        { id: "limpieza", nombre: "Limpieza" },
                        { id: "grafica", nombre: "Grafica" }
                    ]
                },
                {
                    id: "elementosSeguridad",
                    titulo: "5-ELEMENTOS DE SEGURIDAD",
                    tipo: "check",
                    items: [
                        { id: "extintorSemi", nombre: "Extintor semi" },
                        { id: "extintorCabina", nombre: "Extintor Cabina" },
                        { id: "botiquin", nombre: "Botiquin de primeros auxilios" },
                        { id: "conosSeguridad", nombre: "Conos de seguridad" },
                        { id: "cunasGoma", nombre: "Cuñas de goma" },
                        { id: "banderines", nombre: "Banderines" },
                        { id: "cintasReflectivas", nombre: "Cintas reflectivas" },
                        { id: "cartelesSeguridad", nombre: "Carteles de seguridad" }
                    ]
                },
                {
                    id: "elementosEPP", 
                    titulo: "6-ELEMENTOS DE EPP", 
                    tipo: "check",
                    items: [
                        { id: "casco", nombre: "Casco" },
                        { id: "calzadoSeguridad", nombre: "Calzado de seguridad" },
                        { id: "anteojosSeguridad", nombre: "Anteojos de seguridad" },
                        { id: "guantes", nombre: "Guantes" },
                        { id: "chalecoReflectivo", nombre: "Chaleco reflectivo" },
                        { id: "proteccionAuditiva", nombre: "Proteccion auditiva" },
                        { id: "arnes", nombre: "Arnes" },
                        { id: "mangaAnticorte", nombre: "Guantes/Manga anticorte" }
                    ]
                },
                {
                    id: "elementosCargas",
                    titulo: "7-ELEMENTOS DE CARGAS",
                    tipo: "cantidad",
                    items: [
                        { id: "juegoArcos", nombre: "JUEGO DE ARCOS" },
                        { id: "cadenas", nombre: "CADENAS" },
                        { id: "cantoneras", nombre: "CANTONERAS" },
                        { id: "cunasBobinas", nombre: "CUÑAS BOBINAS" },
                        { id: "cunasAlambron", nombre: "CUÑAS ALAMBRON" },
                        { id: "estaqueras", nombre: "ESTAQUERAS" },
                        { id: "juegoFajasChicas", nombre: "JUEGO DE FAJAS CHICAS" },
                        { id: "juegoFajasAncha", nombre: "JUEGO DE FAJAS ANCHA" },
                        { id: "geomantas", nombre: "GEOMANTAS" },
                        { id: "kitAntiderrame", nombre: "KIT ANTIDERRAME" },
                        { id: "lonaGrande", nombre: "LONA GRANDE" },
                        { id: "lonaDobleEnlonado", nombre: "LONA DOBLE ENLONADO" },
                        { id: "ponchosBobina", nombre: "PONCHOS BOBINA" },
                        { id: "ponchosBobinon", nombre: "PONCHOS BOBINON" },
                        { id: "tacosFinos", nombre: "TACOS FINOS" },
                        { id: "tacosBobina", nombre: "TACOS BOBINA" },
                        { id: "sogaPrecinto", nombre: "SOGA PRECINTO" }
                    ]
                }
            ]
        };

        // Variables globales para los modos de inspección
        let modoInspeccionParcial = false;
        let modoInspeccionDiario = false;

        // Función para generar secciones a partir del JSON
        function generarSecciones(datos) {
            const contenedor = document.getElementById('secciones-container');
            contenedor.innerHTML = '';
            
            datos.secciones.forEach(seccion => {
                let contenidoTabla = '';
                
                if (seccion.tipo === "check") {
                    contenidoTabla = `
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-300 p-2 md:p-3 text-left">ITEMS A CONTROLAR</th>
                                <th class="border border-gray-300 p-2 md:p-3 text-center w-10 md:w-12">SI</th>
                                <th class="border border-gray-300 p-2 md:p-3 text-center w-10 md:w-12">NO</th>
                                <th class="border border-gray-300 p-2 md:p-3 text-center w-10 md:w-12">N/A</th>
                                <th class="border border-gray-300 p-2 md:p-3 text-left">OBSERVACIONES</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${seccion.items.map(item => `
                                <tr class="item-row touch-target" data-item="${item.id}">
                                    <td class="border border-gray-300 p-2 md:p-3">${item.nombre}</td>
                                    <td class="border border-gray-300 p-1 text-center">
                                        <div class="radio-container">
                                            <input type="radio" name="${item.id}" value="si" required
                                                   class="radio-input" data-seccion="${seccion.id}">
                                        </div>
                                    </td>
                                    <td class="border border-gray-300 p-1 text-center">
                                        <div class="radio-container">
                                            <input type="radio" name="${item.id}" value="no"
                                                   class="radio-input" data-seccion="${seccion.id}">
                                        </div>
                                    </td>
                                    <td class="border border-gray-300 p-1 text-center">
                                        <div class="radio-container">
                                            <input type="radio" name="${item.id}" value="na"
                                                   class="radio-input" data-seccion="${seccion.id}">
                                        </div>
                                    </td>
                                    <td class="border border-gray-300 p-2 md:p-3">
                                        <textarea name="obs_${item.id}" 
                                                  class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                } else if (seccion.tipo === "cantidad") {
                    contenidoTabla = `
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-300 p-2 md:p-3 text-left">ITEMS A CONTROLAR</th>
                                <th class="border border-gray-300 p-2 md:p-3 text-center w-24 md:w-32">CANTIDAD</th>
                                <th class="border border-gray-300 p-2 md:p-3 text-left">OBSERVACIONES</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${seccion.items.map(item => `
                                <tr class="item-row touch-target" data-item="${item.id}">
                                    <td class="border border-gray-300 p-2 md:p-3">${item.nombre}</td>
                                    <td class="border border-gray-300 p-2 md:p-3">
                                        <input type="number" name="${item.id}" min="0" required
                                               class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm cantidad-input"
                                               data-seccion="${seccion.id}" value="0">
                                    </td>
                                    <td class="border border-gray-300 p-2 md:p-3">
                                        <textarea name="obs_${item.id}" 
                                                  class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                }

                const seccionHTML = `
                    <div class="seccion mb-2 md:mb-4 section-container" data-id="${seccion.id}">
                        <div class="bg-gray-100 p-3 md:p-4 cursor-pointer flex justify-between items-center section-header touch-target" data-section="${seccion.id}">
                            <h2 class="font-bold">${seccion.titulo}</h2>
                            <div class="flex items-center">
                                <span class="progress-indicator text-xs text-gray-600 mr-2" id="progress-${seccion.id}">0/${seccion.items.length}</span>
                                <span class="text-xl font-bold toggle-icon">+</span>
                            </div>
                        </div>
                        <div class="section-content hidden" id="${seccion.id}">
                            <div class="overflow-x-auto table-scroll">
                                <table class="w-full border-collapse">
                                    ${contenidoTabla}
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                contenedor.innerHTML += seccionHTML;
            });
        }

        // Cargar datos de JSON personalizado
        function cargarDatosJSON(jsonURL) {
            fetch(jsonURL)
                .then(response => response.json())
                .then(data => {
                    generarSecciones(data);
                    configurarSecciones();
                    configurarRadioInputs();
                    actualizarProgreso();
                })
                .catch(error => {
                    console.error('Error al cargar el JSON:', error);
                    // Si falla, usamos los datos predeterminados
                    generarSecciones(datosFormulario);
                    configurarSecciones();
                    configurarRadioInputs();
                    actualizarProgreso();
                });
        }

        // Función para configurar las secciones desplegables
        function configurarSecciones() {
            // Configurar eventos para las secciones desplegables
            const sectionHeaders = document.querySelectorAll('.section-header');
            
            sectionHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    const content = document.getElementById(sectionId);
                    const toggleIcon = this.querySelector('.toggle-icon');
                    
                    // Toggle active class
                    content.classList.toggle('hidden');
                    toggleIcon.textContent = content.classList.contains('hidden') ? '+' : '-';
                });
            });
        }

        // Configurar eventos para radios y mejorar UX móvil
        function configurarRadioInputs() {
            const radios = document.querySelectorAll('.radio-input');
            const cantidadInputs = document.querySelectorAll('.cantidad-input');
            
            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const row = this.closest('.item-row');
                    row.classList.add('bg-green-50');
                    actualizarProgresoSeccion(this.getAttribute('data-seccion'));
                    actualizarProgreso();
                });
                
                const container = radio.closest('.radio-container');
                container.addEventListener('click', function(e) {
                    if (e.target !== radio) {
                        radio.checked = true;
                        const event = new Event('change');
                        radio.dispatchEvent(event);
                    }
                });
            });

            cantidadInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const row = this.closest('.item-row');
                    if (this.value && this.value > 0) {
                        row.classList.add('bg-green-50');
                    } else {
                        row.classList.remove('bg-green-50');
                    }
                    actualizarProgresoSeccion(this.getAttribute('data-seccion'));
                    actualizarProgreso();
                });
            });
        }
        
        // Actualizar progreso de una sección específica
        function actualizarProgresoSeccion(seccionId) {
            const seccion = document.getElementById(seccionId);
            const totalItems = seccion.querySelectorAll('.item-row').length;
            const completadosRadio = seccion.querySelectorAll('.item-row input[type="radio"]:checked').length;
            const completadosCantidad = Array.from(seccion.querySelectorAll('.item-row input[type="number"]'))
                .filter(input => input.value && input.value > 0).length;
            const completados = completadosRadio + completadosCantidad;
            
            const progressIndicator = document.getElementById(`progress-${seccionId}`);
            if (progressIndicator) {
                progressIndicator.textContent = `${completados}/${totalItems}`;
                
                if (completados === totalItems) {
                    progressIndicator.classList.add('text-green-600', 'font-bold');
                    progressIndicator.classList.remove('text-gray-600');
                    const header = document.querySelector(`.section-header[data-section="${seccionId}"]`);
                    header.classList.add('bg-green-100');
                } else {
                    progressIndicator.classList.remove('text-green-600', 'font-bold');
                    progressIndicator.classList.add('text-gray-600');
                    const header = document.querySelector(`.section-header[data-section="${seccionId}"]`);
                    header.classList.remove('bg-green-100');
                }
            }
        }
        
        // Actualizar progreso global del formulario
        function actualizarProgreso() {
            // Seleccionar solo los items en secciones visibles
            const itemsVisibles = Array.from(document.querySelectorAll('.item-row')).filter(item => {
                const seccionContainer = item.closest('.section-container');
                return seccionContainer && seccionContainer.style.display !== 'none';
            });
            
            const totalItems = itemsVisibles.length;
            
            // Contar solo radios completados en secciones visibles
            const completadosRadio = itemsVisibles.filter(item => {
                const itemId = item.getAttribute('data-item');
                return document.querySelector(`input[type="radio"][name="${itemId}"]:checked`);
            }).length;
            
            // Contar solo cantidades completadas en secciones visibles
            const completadosCantidad = itemsVisibles.filter(item => {
                const itemId = item.getAttribute('data-item');
                const input = document.querySelector(`input[type="number"][name="${itemId}"]`);
                return input && input.value && parseInt(input.value, 10) > 0;
            }).length;
            
            const completados = completadosRadio + completadosCantidad;
            
            // Calcular porcentaje
            const porcentaje = totalItems > 0 ? Math.round((completados / totalItems) * 100) : 0;
            
            // Actualizar barra de progreso y mensaje
            document.getElementById('progress-bar').style.width = `${porcentaje}%`;
            document.getElementById('status-message').textContent = `Completado: ${porcentaje}% (${completados}/${totalItems} items)`;
            
            // Mostrar barra de estado si hay algún progreso o si estamos en modo parcial
            if (completados > 0 || modoInspeccionParcial) {
                document.getElementById('status-bar').classList.remove('hidden');
            } else if (completados === 0 && !modoInspeccionParcial) {
                document.getElementById('status-bar').classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Cargar fecha y hora actual
            const fechaHoraInput = document.getElementById('fechaHora');
            if (fechaHoraInput) {
                const now = new Date();
                // Ajustar la zona horaria local para el formato datetime-local
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                fechaHoraInput.value = now.toISOString().slice(0, 16);
            }

            // Modal de selección de modo
            const modalSeleccionModo = document.getElementById('modalSeleccionModo');
            const btnSeleccionarDiario = document.getElementById('btnSeleccionarDiario');
            const btnSeleccionarParcial = document.getElementById('btnSeleccionarParcial');
            const btnSeleccionarCompleto = document.getElementById('btnSeleccionarCompleto');

            // Función para cerrar el modal de selección y aplicar el modo
            function seleccionarModo(tipoDiario, tipoParcial) {
                modoInspeccionDiario = tipoDiario;
                modoInspeccionParcial = tipoParcial;
                
                // Actualizar el botón del formulario
                actualizarBotonModo();
                
                // Aplicar el modo seleccionado
                aplicarModoInspeccion();
                
                // Cerrar modal
                modalSeleccionModo.classList.add('hidden');
            }

            // Función para actualizar el botón de modo según el estado actual
            function actualizarBotonModo() {
                const botonModo = document.getElementById('btnModoInspeccion');
                if (!botonModo) return;
                
                if (modoInspeccionDiario && !modoInspeccionParcial) {
                    botonModo.textContent = 'MODO DIARIO (Secciones 1, 2, 3 y 4)';
                    botonModo.className = 'w-full md:w-auto bg-blue-500 text-white px-4 py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors touch-target';
                } else if (!modoInspeccionDiario && modoInspeccionParcial) {
                    botonModo.textContent = 'MODO PARCIAL (Secciones 5, 6 y 7)';
                    botonModo.className = 'w-full md:w-auto bg-green-500 text-white px-4 py-3 rounded-lg font-bold hover:bg-green-600 transition-colors touch-target';
                } else {
                    botonModo.textContent = 'MODO COMPLETO (Todas las secciones)';
                    botonModo.className = 'w-full md:w-auto bg-gray-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-gray-700 transition-colors touch-target';
                }
            }

            // Event listeners para los botones de selección
            btnSeleccionarDiario.addEventListener('click', () => {
                seleccionarModo(true, false); // Diario
            });

            btnSeleccionarParcial.addEventListener('click', () => {
                seleccionarModo(false, true); // Parcial
            });

            btnSeleccionarCompleto.addEventListener('click', () => {
                seleccionarModo(false, false); // Completo
            });

            // Modal de Carga de Datos
            const modalCargaDatos = document.getElementById('modalCargaDatos');
            const btnCargarDatos = document.getElementById('btnCargarDatos');
            const btnCerrarModalDatos = document.getElementById('btnCerrarModalDatos');
            const btnRetryCargarDatos = document.getElementById('btnRetryCargarDatos');
            let datosLogistica = [];

            // Función para cargar datos de logística desde la API
            async function cargarDatosLogistica() {
                const loading = document.getElementById('cargaDatosLoading');
                const tabla = document.getElementById('tablaDatosContainer');
                const error = document.getElementById('errorCargaDatos');

                // Mostrar loading y ocultar otros elementos
                loading.classList.remove('hidden');
                tabla.classList.add('hidden');
                error.classList.add('hidden');

                try {
                    const response = await fetch('/.netlify/functions/logistica');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    datosLogistica = data.results || data || [];
                    
                    renderTablaLogistica(datosLogistica);
                    tabla.classList.remove('hidden');
                } catch (err) {
                    console.error('Error cargando datos de logística:', err);
                    error.classList.remove('hidden');
                } finally {
                    loading.classList.add('hidden');
                }
            }

            // Función para renderizar la tabla de logística
            function renderTablaLogistica(datos) {
                const tbody = document.getElementById('tablaDatosBody');
                tbody.innerHTML = '';

                if (datos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No hay unidades disponibles</td></tr>';
                    return;
                }

                datos.forEach((unidad, index) => {
                    const chofer = unidad.chofer || {};
                    const conjunto = unidad.conjunto_veh || {};
                    const camion = conjunto.camiones || {};
                    const semi1 = conjunto.semi1 || {};
                    const semi2 = conjunto.semi2 || {};

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                ${chofer.apellido ? `${chofer.apellido}, ${chofer.nombre}` : 'N/A'}
                            </div>
                            <div class="text-sm text-gray-500">DNI: ${chofer.dni || 'N/A'}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${camion.patente || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${camion.marca ? `${camion.marca} ${camion.modelo}` : ''}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${semi1.patente || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${semi1.marca ? `${semi1.marca}` : ''}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${semi2.patente || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${semi2.marca ? `${semi2.marca}` : ''}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <button onclick="seleccionarUnidad(${index})" 
                                    class="bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 transition-colors text-sm">
                                Seleccionar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Función para filtrar datos de logística
            function filtrarDatosLogistica() {
                const filtroChofer = document.getElementById('filtroChoferModal').value.toLowerCase();
                const filtroPatente = document.getElementById('filtroPatenteModal').value.toLowerCase();

                const datosFiltrados = datosLogistica.filter(unidad => {
                    const chofer = unidad.chofer || {};
                    const conjunto = unidad.conjunto_veh || {};
                    const camion = conjunto.camiones || {};

                    const apellidoChofer = (chofer.apellido || '').toLowerCase();
                    const patenteFilter = (camion.patente || '').toLowerCase();

                    const coincideChofer = !filtroChofer || apellidoChofer.includes(filtroChofer);
                    const coincidePatente = !filtroPatente || patenteFilter.includes(filtroPatente);

                    return coincideChofer && coincidePatente;
                });

                renderTablaLogistica(datosFiltrados);
            }

            // Función para seleccionar una unidad (se expone globalmente)
            window.seleccionarUnidad = function(index) {
                const unidad = datosLogistica[index];
                if (!unidad) return;

                const chofer = unidad.chofer || {};
                const conjunto = unidad.conjunto_veh || {};
                const camion = conjunto.camiones || {};
                const semi1 = conjunto.semi1 || {};
                const semi2 = conjunto.semi2 || {};

                // Rellenar campos del formulario
                if (chofer.apellido && chofer.nombre) {
                    document.getElementById('chofer').value = `${chofer.apellido}, ${chofer.nombre}`.toUpperCase();
                }
                if (camion.patente) {
                    document.getElementById('tractor').value = camion.patente.toUpperCase();
                }
                // Priorizar Semi 1, pero usar Semi 2 si Semi 1 no está disponible
                if (semi1.patente) {
                    document.getElementById('semi').value = semi1.patente.toUpperCase();
                } else if (semi2.patente) {
                    document.getElementById('semi').value = semi2.patente.toUpperCase();
                }

                // Cerrar modal
                modalCargaDatos.classList.add('hidden');

                // Mostrar mensaje de confirmación temporal
                const choferInput = document.getElementById('chofer');
                const originalBorder = choferInput.style.border;
                choferInput.style.border = '2px solid #10B981';
                setTimeout(() => {
                    choferInput.style.border = originalBorder;
                }, 2000);
            };

            // Event listeners para el modal de carga de datos
            btnCargarDatos.addEventListener('click', function() {
                // Cambiar icono temporalmente mientras se abre
                const originalHTML = this.innerHTML;
                this.innerHTML = `
                    <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                `;
                
                modalCargaDatos.classList.remove('hidden');
                cargarDatosLogistica().finally(() => {
                    // Restaurar icono original después de cargar
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                    }, 500);
                });
            });

            btnCerrarModalDatos.addEventListener('click', function() {
                modalCargaDatos.classList.add('hidden');
            });

            btnRetryCargarDatos.addEventListener('click', cargarDatosLogistica);

            // Filtros del modal
            document.getElementById('filtroChoferModal').addEventListener('input', filtrarDatosLogistica);
            document.getElementById('filtroPatenteModal').addEventListener('input', filtrarDatosLogistica);

            // Cerrar modal con ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !modalCargaDatos.classList.contains('hidden')) {
                    modalCargaDatos.classList.add('hidden');
                }
            });

            // Botón para ciclar entre modos de inspección
            const btnModoInspeccion = document.getElementById('btnModoInspeccion');
            if (btnModoInspeccion) {
                btnModoInspeccion.addEventListener('click', function() {
                    // Ciclar entre los tres modos: completo -> diario -> parcial -> completo
                    if (!modoInspeccionDiario && !modoInspeccionParcial) {
                        // Modo completo -> Modo diario
                        modoInspeccionDiario = true;
                        modoInspeccionParcial = false;
                        this.textContent = 'MODO DIARIO (Secciones 1, 2, 3 y 4)';
                        this.className = 'w-full md:w-auto bg-blue-500 text-white px-4 py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors touch-target';
                    } else if (modoInspeccionDiario && !modoInspeccionParcial) {
                        // Modo diario -> Modo parcial
                        modoInspeccionDiario = false;
                        modoInspeccionParcial = true;
                        this.textContent = 'MODO PARCIAL (Secciones 5, 6 y 7)';
                        this.className = 'w-full md:w-auto bg-green-500 text-white px-4 py-3 rounded-lg font-bold hover:bg-green-600 transition-colors touch-target';
                    } else {
                        // Modo parcial -> Modo completo
                        modoInspeccionDiario = false;
                        modoInspeccionParcial = false;
                        this.textContent = 'MODO COMPLETO (Todas las secciones)';
                        this.className = 'w-full md:w-auto bg-gray-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-gray-700 transition-colors touch-target';
                    }
                    
                    // Aplicar el modo de inspección
                    aplicarModoInspeccion();
                });
            }
            
            // Función para aplicar el modo de inspección
            function aplicarModoInspeccion() {
                // IDs de las secciones que queremos mostrar en cada modo
                const seccionesParcialesIds = ['elementosSeguridad', 'elementosEPP', 'elementosCargas']; // Secciones 5, 6, 7
                const seccionesDiariasIds = ['sistemaElectrico', 'seccionTractor', 'semirremolque', 'general']; // Secciones 1, 2, 3, 4
                
                // Recorrer todas las secciones
                datosFormulario.secciones.forEach(seccion => {
                    const seccionContainer = document.querySelector(`.section-container[data-id="${seccion.id}"]`);
                    
                    if (seccionContainer) {
                        let esMostrar = true; // Por defecto mostrar (modo completo)
                        
                        if (modoInspeccionParcial) {
                            // En modo parcial: mostrar solo las secciones 5, 6 y 7
                            esMostrar = seccionesParcialesIds.includes(seccion.id);
                        } else if (modoInspeccionDiario) {
                            // En modo diario: mostrar solo las secciones 1, 2, 3 y 4
                            esMostrar = seccionesDiariasIds.includes(seccion.id);
                        }
                        // En modo completo esMostrar = true para todas
                        
                        seccionContainer.style.display = esMostrar ? 'block' : 'none';
                        
                        // Hacer los inputs requeridos o no según corresponda
                        seccion.items.forEach(item => {
                            const inputs = document.querySelectorAll(`[name="${item.id}"]`);
                            inputs.forEach(input => {
                                if (esMostrar) {
                                    // Si la sección se muestra, mantener el required
                                    if (!input.hasAttribute('data-required-original')) {
                                        input.setAttribute('data-required-original', input.required);
                                    }
                                } else {
                                    // Si la sección se oculta, quitar el required
                                    if (!input.hasAttribute('data-required-original')) {
                                        input.setAttribute('data-required-original', input.required);
                                    }
                                    input.required = false;
                                }
                            });
                        });
                    }
                });
                
                // Recalcular progreso visible
                calcularProgresoVisible();
                // Actualizar el progreso
                actualizarProgreso();
            }
            
            // Función para calcular el progreso solo de secciones visibles
            function calcularProgresoVisible() {
                datosFormulario.secciones.forEach(seccion => {
                    const seccionContainer = document.querySelector(`.section-container[data-id="${seccion.id}"]`);
                    if (seccionContainer && seccionContainer.style.display !== 'none') {
                        actualizarProgresoSeccion(seccion.id);
                    }
                });
            }

            // Generar secciones con los datos predeterminados
            generarSecciones(datosFormulario);
            
            // Configurar secciones desplegables
            configurarSecciones();
            
            // Configurar inputs radio para mejor UX móvil
            configurarRadioInputs();

            // Convertir a mayúsculas en campos específicos
            const uppercaseInputs = ['chofer', 'tractor', 'semi'];
            uppercaseInputs.forEach(id => {
                const inputElement = document.getElementById(id);
                if (inputElement) {
                    inputElement.addEventListener('input', function() {
                        this.value = this.value.toUpperCase();
                    });
                }
            });
            
            // Para cargar desde un JSON externo, descomentar:
            // cargarDatosJSON('ruta/a/tu/datos.json');
            
            // Función para expandir todas las secciones
            document.getElementById('btnExpandirTodo').addEventListener('click', function() {
                const todosLosHeaders = document.querySelectorAll('.section-header');
                const todasLasSecciones = document.querySelectorAll('.section-content');
                
                // Verificar si todas están abiertas o no
                const todasAbiertas = Array.from(todasLasSecciones).every(seccion => !seccion.classList.contains('hidden'));
                
                if (todasAbiertas) {
                    // Cerrar todas
                    this.textContent = 'Expandir Todo';
                    todasLasSecciones.forEach(seccion => {
                        seccion.classList.add('hidden');
                    });
                    document.querySelectorAll('.toggle-icon').forEach(icon => {
                        icon.textContent = '+';
                    });
                } else {
                    // Abrir todas
                    this.textContent = 'Contraer Todo';
                    todasLasSecciones.forEach(seccion => {
                        seccion.classList.remove('hidden');
                    });
                    document.querySelectorAll('.toggle-icon').forEach(icon => {
                        icon.textContent = '-';
                    });
                }
            });

            // Función para Pantalla Completa
            const btnPantallaCompleta = document.getElementById('btnPantallaCompleta');
            const svgExpand = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>`;
            const svgContract = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l-5 5m0 0l5-5m-5 5v-4m5 4h-4M4 10l5-5m0 0l-5 5m5-5v4M4 4h4m10 10l5 5m0 0l-5-5m5 5v-4m-5 4h4m-4-6l-5-5m0 0l5 5m-5-5v4m5-4h4" /></svg>`;

            if (btnPantallaCompleta) {
                btnPantallaCompleta.addEventListener('click', function() {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(err => {
                            alert(`Error al intentar entrar en pantalla completa: ${err.message} (${err.name})`);
                        });
                        this.innerHTML = svgContract; // Cambiar a icono de contraer
                        this.title = 'Salir Pantalla Completa';
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                            this.innerHTML = svgExpand; // Cambiar a icono de expandir
                            this.title = 'Pantalla Completa';
                        }
                    }
                });
            
                // Actualizar el icono del botón si se sale de pantalla completa con ESC
                document.addEventListener('fullscreenchange', () => {
                    if (!document.fullscreenElement) {
                        btnPantallaCompleta.innerHTML = svgExpand; 
                        btnPantallaCompleta.title = 'Pantalla Completa';
                    }
                });
            }

            // Validar formulario antes de enviar
            const form = document.getElementById('formVehiculo');
            const submitButton = form.querySelector('button[type="submit"]'); // Obtener el botón de guardar
            const modal = document.getElementById('modalGuardar');
            const btnGuardarCompartir = document.getElementById('btnGuardarCompartir');
            const btnGuardarAbrir = document.getElementById('btnGuardarAbrir');
            const btnGuardarDescargar = document.getElementById('btnGuardarDescargar');
            const btnCancelarModal = document.getElementById('btnCancelarModal');
            let accionPDFSeleccionada = 'download'; // Por defecto descarga
            
            // Modificar el listener del botón de submit original
            submitButton.addEventListener('click', function(e) {
                e.preventDefault(); // Prevenir envío automático
                // Mostrar el modal en lugar de enviar
                modal.classList.remove('hidden'); 
            });

            // Función para cerrar el modal
            function cerrarModal() {
                modal.classList.add('hidden');
            }

            // Listener para cancelar
            btnCancelarModal.addEventListener('click', cerrarModal);

            // Función para manejar el proceso de guardado real
            function procederConGuardado() {
                cerrarModal(); // Ocultar modal

                // Deshabilitar botón para evitar duplicados
                submitButton.disabled = true;
                submitButton.textContent = 'Guardando...'; // Cambiar texto del botón
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');

                // Validar que todos los campos requeridos estén completos
                const requiredInputs = document.querySelectorAll('[required]');
                let isValid = true;
                let seccionesIncompletas = new Set();
                
                requiredInputs.forEach(input => {
                    // Solo validar campos que están visibles (para modo parcial)
                    const seccionElement = input.closest('.section-container');
                    if (seccionElement && seccionElement.style.display === 'none') {
                        return; // Saltar validación para elementos en secciones ocultas
                    }
                    
                    if (input.type === 'radio') {
                        const name = input.name;
                        const checked = document.querySelector(`input[name="${name}"]:checked`);
                        if (!checked) {
                            isValid = false;
                            const seccionElement = input.closest('.section-content');
                            if (seccionElement) seccionesIncompletas.add(seccionElement.id);
                            const row = document.querySelector(`[data-item="${name}"]`);
                            if (row) row.classList.add('bg-red-50');
                        } else {
                            const row = document.querySelector(`[data-item="${name}"]`);
                            if (row) row.classList.remove('bg-red-50');
                        }
                    } else if (!input.value && input.value !== "0") { // Permitir 0 en campos numéricos
                        isValid = false;
                        input.classList.add('border-red-500', 'bg-red-50');
                    } else {
                        input.classList.remove('border-red-500', 'bg-red-50');
                    }
                });
                
                if (!isValid) {
                    seccionesIncompletas.forEach(seccionId => {
                        const seccion = document.getElementById(seccionId);
                        if (seccion.classList.contains('hidden')) {
                            const header = document.querySelector(`.section-header[data-section="${seccionId}"]`);
                            header.click();
                        }
                    });
                    const elementosFaltantes = Array.from(requiredInputs).filter(input => {
                        // Solo contar elementos en secciones visibles
                        const seccionElement = input.closest('.section-container');
                        return seccionElement && seccionElement.style.display !== 'none' && !input.validity.valid;
                    }).length;
                    
                    alert(`Por favor complete todos los campos requeridos. Faltan ${elementosFaltantes} elementos.`);
                    // Habilitar el botón si la validación falla
                    submitButton.disabled = false;
                    submitButton.textContent = 'Guardar Inspección';
                    submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    return;
                }
                
                // Crear objeto JSON con la estructura deseada
                const jsonDataToSend = {
                    fechaHora: form.elements.fechaHora.value,
                    chofer: form.elements.chofer.value,
                    tractor: form.elements.tractor.value,
                    semi: form.elements.semi.value,
                    // Agrega aquí kmCamion y semi2 si los añadiste al HTML
                    // kmCamion: form.elements.kmCamion?.value || '', 
                    // semi2: form.elements.semi2?.value || '',
                    modoParcial: modoInspeccionParcial, // Indicar si se usó modo parcial
                    modoDiario: modoInspeccionDiario, // Indicar si se usó modo diario 
                    secciones: {}
                };

                // Determinar qué secciones incluir según el modo actual
                let seccionesAIncluir;
                if (modoInspeccionParcial) {
                    seccionesAIncluir = datosFormulario.secciones.filter(seccion => 
                        ['elementosSeguridad', 'elementosEPP', 'elementosCargas'].includes(seccion.id));
                } else if (modoInspeccionDiario) {
                    seccionesAIncluir = datosFormulario.secciones.filter(seccion => 
                        ['sistemaElectrico', 'seccionTractor', 'semirremolque', 'general'].includes(seccion.id));
                } else {
                    seccionesAIncluir = datosFormulario.secciones;
                }

                seccionesAIncluir.forEach(seccion => {
                    jsonDataToSend.secciones[seccion.id] = {};
                    seccion.items.forEach(item => {
                        const observacionInput = form.elements[`obs_${item.id}`];
                        const observacion = observacionInput ? observacionInput.value : '';

                        if (seccion.tipo === 'check') {
                            const radioChecked = form.querySelector(`input[name="${item.id}"]:checked`);
                            const valor = radioChecked ? radioChecked.value : '';
                            jsonDataToSend.secciones[seccion.id][item.id] = {
                                valor: valor,
                                observacion: observacion
                            };
                        } else if (seccion.tipo === 'cantidad') {
                            const cantidadInput = form.elements[item.id];
                            const cantidadStr = cantidadInput ? cantidadInput.value : '0';
                            // Convertir la cantidad a número
                            const cantidadNum = parseInt(cantidadStr, 10);
                            // Usar 0 si la conversión falla (aunque type=number debería prevenirlo)
                            const cantidadFinal = isNaN(cantidadNum) ? 0 : cantidadNum; 
                            jsonDataToSend.secciones[seccion.id][item.id] = {
                                cantidad: cantidadFinal, // Usar el valor numérico
                                observacion: observacion
                            };
                        }
                    });
                });
                
                const jsonDataString = JSON.stringify(jsonDataToSend);
                console.log('Datos a enviar (estructurados):', jsonDataString);
                
                // Salir de pantalla completa si está activa
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }

                // Enviar datos por POST
                fetch('https://hook.us2.make.com/s3uhwkuujk4xld7nnv96fcrye09gzn5z', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: jsonDataString // Enviar el JSON estructurado
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP ${response.status} - ${response.statusText}`);
                    }
                    return response.text(); 
                })
                .then(text => {
                    console.log("Respuesta cruda del servidor (texto):", text);
                    // Verificar si la respuesta es exactamente "Accepted"
                    if (text.trim().toLowerCase() === "accepted") { // Usar toLowerCase para ser más flexible
                        // --- Éxito --- 
                        console.log('Respuesta del servidor interpretada como éxito ("Accepted").');
                        // Generar PDF después de guardar exitosamente con la acción seleccionada
                        generarPDF(accionPDFSeleccionada);
                        alert('Inspección guardada correctamente');
                        // Habilitar el botón después de éxito
                        submitButton.disabled = false;
                        submitButton.textContent = 'Guardar Inspección';
                        submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        // --- Fin Éxito ---
                    } else {
                        // Si la respuesta es 200 OK pero no es "Accepted", tratar como error
                        console.error("Respuesta inesperada del servidor (se esperaba 'Accepted'):", text);
                        throw new Error('Respuesta inesperada del servidor.');
                    }
                })
                .catch(error => {
                    // Captura errores de red, errores HTTP (4xx, 5xx), y la respuesta inesperada
                    alert(`Error al guardar o procesar respuesta: ${error.message}`);
                    console.error('Error detallado:', error);
                    // Salir de pantalla completa si está activa (también en caso de error)
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                    // Habilitar el botón después de error
                    submitButton.disabled = false;
                    submitButton.textContent = 'Guardar Inspección';
                    submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                });
            }

            // Listeners para los botones del modal
            btnGuardarCompartir.addEventListener('click', () => {
                accionPDFSeleccionada = 'share';
                procederConGuardado();
            });
            btnGuardarAbrir.addEventListener('click', () => {
                accionPDFSeleccionada = 'open';
                procederConGuardado();
            });
            btnGuardarDescargar.addEventListener('click', () => {
                accionPDFSeleccionada = 'download';
                procederConGuardado();
            });

            // Mantener todas las secciones recogidas inicialmente
            // (No abrir automáticamente la primera sección)
            
            // Inicializar contadores de progreso
            datosFormulario.secciones.forEach(seccion => {
                actualizarProgresoSeccion(seccion.id);
            });
            actualizarProgreso();
        });

        // Función para añadir una nueva sección al formulario
        function agregarSeccion(seccionData) {
            // Añadir la nueva sección al objeto de datos
            datosFormulario.secciones.push(seccionData);
            
            // Regenerar las secciones
            generarSecciones(datosFormulario);
            
            // Reconfigurar eventos de las secciones
            configurarSecciones();
            configurarRadioInputs();
            actualizarProgreso();
        }

        // Función para generar PDF
        function generarPDF(accion = 'download') {
            // Obtener los datos del formulario
            const formData = new FormData(document.getElementById('formVehiculo'));
            const formDataObj = {};
            formData.forEach((value, key) => {
                formDataObj[key] = value;
            });

            // Determinar qué secciones incluir según el modo actual
            let seccionesAIncluir;
            if (modoInspeccionParcial) {
                seccionesAIncluir = datosFormulario.secciones.filter(seccion => 
                    ['elementosSeguridad', 'elementosEPP', 'elementosCargas'].includes(seccion.id));
            } else if (modoInspeccionDiario) {
                seccionesAIncluir = datosFormulario.secciones.filter(seccion => 
                    ['sistemaElectrico', 'seccionTractor', 'semirremolque', 'general'].includes(seccion.id));
            } else {
                seccionesAIncluir = datosFormulario.secciones;
            }
            
            // Definir el contenido del PDF
            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [40, 40, 40, 40],
                content: [
                    // Encabezado estilo imagen
                    {
                        table: {
                            widths: ['25%', '50%', '25%'],
                            body: [
                                [
                                    // Celda para el logo (requiere imagen base64)
                                    { text: 'TRANSPORTE IBARRA S.A.', style: 'header', alignment: 'center', margin: [0, 10, 0, 10] }, 
                                    { text: 'CHECK DE VERIFICACIÓN DE VEHÍCULO', style: 'subheader', alignment: 'center', margin: [0, 10, 0, 10] },
                                    { text: 'FORMULARIO A1', style: 'formNumber', alignment: 'center', margin: [0, 10, 0, 10] }
                                ]
                            ]
                        },
                        layout: 'headerLines', // Estilo de borde simple
                        margin: [0, 0, 0, 10]
                    },
                    // Modo de inspección
                    modoInspeccionParcial ? {
                        text: 'MODO DE INSPECCIÓN PARCIAL (Solo Secciones 5, 6 y 7)',
                        style: 'modoInspeccion',
                        alignment: 'center',
                        margin: [0, 5, 0, 15]
                    } : modoInspeccionDiario ? {
                        text: 'MODO DE INSPECCIÓN DIARIO (Solo Secciones 1, 2, 3 y 4)',
                        style: 'modoInspeccionDiario',
                        alignment: 'center',
                        margin: [0, 5, 0, 15]
                    } : null,
                    // Información básica estilo imagen
                    {
                        table: {
                            widths: ['auto', '*', 'auto', '*'],
                            body: [
                                [
                                    { text: 'FECHA', style: 'tableHeader' },
                                    { text: formDataObj.fechaHora ? new Date(formDataObj.fechaHora).toLocaleDateString() : '', style: 'tableCell' }, // Formatear fecha
                                    { text: 'CHOFER', style: 'tableHeader' },
                                    { text: formDataObj.chofer || '', style: 'tableCell' }
                                ],
                                [
                                    { text: 'TRACTOR', style: 'tableHeader' },
                                    { text: formDataObj.tractor || '', style: 'tableCell' },
                                    { text: 'SEMI', style: 'tableHeader' },
                                    { text: formDataObj.semi || '', style: 'tableCell' }
                                ],
                            ]
                        },
                        layout: 'lightHorizontalLines', // Estilo de borde simple
                        margin: [0, 0, 0, 10]
                    },
                    // Secciones - Filtrado según el modo seleccionado
                    ...seccionesAIncluir.map(seccion => {
                        const rows = seccion.items.map(item => {
                            if (seccion.tipo === 'check') {
                                const radioValue = formDataObj[item.id] || '';
                                return [
                                    { text: item.nombre, style: 'tableCell' },
                                    { text: radioValue === 'si' ? 'X' : '', style: 'tableCell', alignment: 'center' },
                                    { text: radioValue === 'no' ? 'X' : '', style: 'tableCell', alignment: 'center' },
                                    { text: radioValue === 'na' ? 'X' : '', style: 'tableCell', alignment: 'center' },
                                    { text: formDataObj[`obs_${item.id}`] || '', style: 'tableCell' }
                                ];
                            } else {
                                return [
                                    { text: item.nombre, style: 'tableCell' },
                                    { text: formDataObj[item.id] || '0', style: 'tableCell', alignment: 'center' },
                                    { text: formDataObj[`obs_${item.id}`] || '', style: 'tableCell' }
                                ];
                            }
                        });

                        return [
                            {
                                text: seccion.titulo,
                                style: 'sectionHeader',
                                margin: [0, 20, 0, 10]
                            },
                            {
                                table: {
                                    widths: seccion.tipo === 'check' ? ['40%', '10%', '10%', '10%', '30%'] : ['50%', '20%', '30%'],
                                    headerRows: 1,
                                    body: [
                                        seccion.tipo === 'check' 
                                            ? [
                                                { text: 'ITEMS A CONTROLAR', style: 'tableHeader' },
                                                { text: 'SI', style: 'tableHeader', alignment: 'center' },
                                                { text: 'NO', style: 'tableHeader', alignment: 'center' },
                                                { text: 'N/A', style: 'tableHeader', alignment: 'center' },
                                                { text: 'OBSERVACIONES', style: 'tableHeader' }
                                            ]
                                            : [
                                                { text: 'ITEMS A CONTROLAR', style: 'tableHeader' },
                                                { text: 'CANTIDAD', style: 'tableHeader', alignment: 'center' },
                                                { text: 'OBSERVACIONES', style: 'tableHeader' }
                                            ],
                                        ...rows
                                    ]
                                },
                                layout: {
                                    hLineWidth: function(i, node) { return 1; },
                                    vLineWidth: function(i, node) { return 1; },
                                    hLineColor: function(i, node) { return '#d1d5db'; },
                                    vLineColor: function(i, node) { return '#d1d5db'; }
                                }
                            }
                        ];
                    })
                ],
                styles: {
                    header: {
                        fontSize: 16,
                        bold: true
                    },
                    subheader: {
                        fontSize: 14,
                        bold: true
                    },
                    formNumber: {
                        fontSize: 14,
                        bold: true
                    },
                    modoInspeccion: {
                        fontSize: 12,
                        bold: true,
                        color: '#d97706',
                        background: '#fef3c7'
                    },
                    modoInspeccionDiario: {
                        fontSize: 12,
                        bold: true,
                        color: '#059669',
                        background: '#d1fae5'
                    },
                    sectionHeader: {
                        fontSize: 12,
                        bold: true,
                        color: '#1f2937'
                    },
                    tableHeader: {
                        fontSize: 10,
                        bold: true,
                        fillColor: '#f3f4f6',
                        color: '#1f2937'
                    },
                    tableCell: {
                        fontSize: 10,
                        color: '#1f2937'
                    }
                }
            };

            // Generar nombre de archivo dinámico
            const fechaHora = formDataObj.fechaHora ? new Date(formDataObj.fechaHora) : new Date();
            const year = fechaHora.getFullYear();
            const month = String(fechaHora.getMonth() + 1).padStart(2, '0'); // Meses son 0-indexados
            const day = String(fechaHora.getDate()).padStart(2, '0');
            const fechaFormateada = `${year}${month}${day}`;
            const chofer = formDataObj.chofer || 'SIN_CHOFER';
            const tractor = formDataObj.tractor || 'SIN_TRACTOR';
            const semi = formDataObj.semi || 'SIN_SEMI';
            const nombreArchivo = `${fechaFormateada} - ${chofer} - ${tractor} - ${semi}.pdf`;

            // Generar y realizar acción sobre el PDF
            const pdfDocGenerator = pdfMake.createPdf(docDefinition);

            if (accion === 'share' && navigator.share) {
                pdfDocGenerator.getBlob((blob) => {
                    const file = new File([blob], nombreArchivo, { type: 'application/pdf' });
                    navigator.share({
                        title: nombreArchivo,
                        text: `Check de Vehículo - ${chofer} - ${fechaFormateada}`,
                        files: [file]
                    })
                    .then(() => console.log('Compartido con éxito'))
                    .catch((error) => {
                        console.error('Error al compartir:', error);
                        // Fallback a descarga si falla el share
                        pdfDocGenerator.download(nombreArchivo);
                        alert('No se pudo compartir, se descargará el PDF.');
                    });
                });
            } else if (accion === 'open') {
                pdfDocGenerator.open({}, window.open('', '_blank'));
            } else { // default o share no disponible
                pdfDocGenerator.download(nombreArchivo);
            }
        }
    </script>
</body>
</html> 