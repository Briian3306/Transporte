<div class="user-management-container">
  <!-- Header -->
  <div class="header-section">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-users"></i>
        Gestión de Usuarios
      </h1>
      <p class="page-subtitle">Administra usuarios, roles y permisos del sistema</p>
    </div>
    <div class="header-actions">
      <button 
      (click)="goToRoles()"
      class="btn btn-primary"
      appGranularPermission="users:create"
      appPermissionAction="show">
      <i class="fas fa-user-tag"></i>
      Ver Roles
    </button>
      <button 
        (click)="openCreateModal()"
        class="btn btn-primary"
        appGranularPermission="users:create"
        appPermissionAction="show">
        <i class="fas fa-plus"></i>
        Crear Usuario
      </button>
      
      <a 
        routerLink="/roles"
        class="btn btn-info"
        appGranularPermission="settings:manage"
        appPermissionAction="show">
        <i class="fas fa-user-tag"></i>
        Configurar Roles
      </a>
      
      <a 
        routerLink="/role-permissions"
        class="btn btn-secondary"
        appGranularPermission="settings:manage"
        appPermissionAction="show">
        <i class="fas fa-shield-alt"></i>
        Gestionar Permisos
      </a>
    </div>
  </div>

  <!-- Filtros y búsqueda -->
  <div class="filters-section">
    <div class="filters-row">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          (input)="onSearch()"
          placeholder="Buscar por nombre o email..."
          class="search-input">
      </div>

      <div class="filter-group">
        <select 
          [(ngModel)]="roleFilter" 
          (change)="onFilterChange()"
          class="filter-select">
          <option value="">Todos los roles</option>
          <option *ngFor="let role of roles" [value]="role.id">
            {{ role.name | titlecase }}
          </option>
        </select>

        <select 
          [(ngModel)]="statusFilter" 
          (change)="onFilterChange()"
          class="filter-select">
          <option value="all">Todos los estados</option>
          <option value="active">Activos</option>
          <option value="inactive">Inactivos</option>
        </select>

        <button 
          (click)="clearFilters()" 
          class="btn btn-secondary">
          <i class="fas fa-times"></i>
          Limpiar
        </button>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  <div class="messages-section" *ngIf="errorMessage || successMessage">
    <div class="alert alert-error" *ngIf="errorMessage">
      <i class="fas fa-exclamation-triangle"></i>
      {{ errorMessage }}
    </div>
    <div class="alert alert-success" *ngIf="successMessage">
      <i class="fas fa-check-circle"></i>
      {{ successMessage }}
    </div>
  </div>

  <!-- Tabla de usuarios -->
  <div class="table-section">
    <div class="table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Fecha de Registro</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="loading" class="loading-row">
            <td colspan="5" class="text-center">
              <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                Cargando usuarios...
              </div>
            </td>
          </tr>

          <tr *ngFor="let user of paginatedUsers; trackBy: trackByUserId" class="user-row">
            <td class="user-info">
              <div class="user-avatar">
                <i class="fas fa-user"></i>
              </div>
              <div class="user-details">
                <div class="user-name">{{ user.fullName }}</div>
                <div class="user-email">{{ user.email }}</div>
              </div>
            </td>

            <td class="role-cell">
              <select 
                [(ngModel)]="user.roleId" 
                (change)="updateUserRole(user)"
                class="role-select"
                appGranularPermission="users:update"
                appPermissionAction="show">
                <option *ngFor="let role of roles" [value]="role.id">
                  {{ role.name | titlecase }}
                </option>
              </select>
            </td>

            <td class="status-cell">
              <span class="status-badge" [class]="getStatusBadgeClass(user.isActive)">
                {{ user.isActive ? 'Activo' : 'Inactivo' }}
              </span>
            </td>

            <td class="date-cell">
              {{ user.createdAt | date:'dd/MM/yyyy' }}
            </td>

            <td class="actions-cell">
              <div class="action-buttons">
                <button 
                  (click)="openPermissionModal(user)"
                  class="btn btn-info"
                  title="Gestionar permisos"
                  appGranularPermission="users:update"
                  appPermissionAction="show">
                  <i class="fas fa-key"></i>
                </button>

                <button 
                  (click)="toggleUserStatus(user)"
                  [class]="user.isActive ? 'btn btn-warning' : 'btn btn-success'"
                  [title]="user.isActive ? 'Desactivar usuario' : 'Activar usuario'"
                  appGranularPermission="users:update"
                  appPermissionAction="show">
                  <i [class]="user.isActive ? 'fas fa-user-slash' : 'fas fa-user-check'"></i>
                </button>

                <button 
                  (click)="deleteUser(user)"
                  class="btn btn-danger"
                  title="Eliminar usuario"
                  appGranularPermission="users:delete"
                  appPermissionAction="show">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>

          <tr *ngIf="!loading && paginatedUsers.length === 0" class="empty-row">
            <td colspan="5" class="text-center">
              <div class="empty-state">
                <i class="fas fa-users-slash"></i>
                <h3>No se encontraron usuarios</h3>
                <p>No hay usuarios que coincidan con los filtros aplicados</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="pagination-section" *ngIf="totalPages > 1">
      <div class="pagination-info">
        Mostrando {{ (currentPage - 1) * itemsPerPage + 1 }} - 
        {{ Math.min(currentPage * itemsPerPage, filteredUsers.length) }} 
        de {{ filteredUsers.length }} usuarios
      </div>
      
      <div class="pagination-controls">
        <button 
          (click)="goToPage(currentPage - 1)"
          [disabled]="currentPage === 1"
          class="btn btn-secondary">
          <i class="fas fa-chevron-left"></i>
          Anterior
        </button>

        <div class="page-numbers">
          <button 
            *ngFor="let page of [].constructor(totalPages); let i = index"
            (click)="goToPage(i + 1)"
            [class]="currentPage === i + 1 ? 'btn btn-primary' : 'btn btn-outline'"
            class="page-btn">
            {{ i + 1 }}
          </button>
        </div>

        <button 
          (click)="goToPage(currentPage + 1)"
          [disabled]="currentPage === totalPages"
          class="btn btn-secondary">
          Siguiente
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Creación de Usuario -->
  <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-user-plus"></i>
          Crear Nuevo Usuario
        </h3>
        <button (click)="closeCreateModal()" class="btn-close">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form [formGroup]="userForm" (ngSubmit)="createUser()" class="modal-body">
        <div class="form-group">
          <label for="email">Email *</label>
          <input 
            type="email" 
            id="email"
            formControlName="email"
            class="form-control"
            [class.error]="userForm.get('email')?.invalid && userForm.get('email')?.touched"
            placeholder="usuario@empresa.com">
          <div class="error-message" *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
            <span *ngIf="userForm.get('email')?.errors?.['required']">Email es requerido</span>
            <span *ngIf="userForm.get('email')?.errors?.['email']">Email inválido</span>
          </div>
        </div>

        <div class="form-group">
          <label for="fullName">Nombre Completo *</label>
          <input 
            type="text" 
            id="fullName"
            formControlName="fullName"
            class="form-control"
            [class.error]="userForm.get('fullName')?.invalid && userForm.get('fullName')?.touched"
            placeholder="Nombre Apellido">
          <div class="error-message" *ngIf="userForm.get('fullName')?.invalid && userForm.get('fullName')?.touched">
            <span *ngIf="userForm.get('fullName')?.errors?.['required']">Nombre es requerido</span>
            <span *ngIf="userForm.get('fullName')?.errors?.['minlength']">Mínimo 2 caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <label for="roleId">Rol *</label>
          <select 
            id="roleId"
            formControlName="roleId"
            class="form-control"
            [class.error]="userForm.get('roleId')?.invalid && userForm.get('roleId')?.touched">
            <option value="">Seleccionar rol</option>
            <option *ngFor="let role of roles" [value]="role.id">
              {{ role.name | titlecase }}
            </option>
          </select>
          <div class="error-message" *ngIf="userForm.get('roleId')?.invalid && userForm.get('roleId')?.touched">
            <span>Rol es requerido</span>
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              formControlName="useCustomPassword"
              class="checkbox-input">
            <span class="checkbox-text">Establecer contraseña personalizada</span>
          </label>
        </div>

        <div class="form-group" *ngIf="userForm.get('useCustomPassword')?.value">
          <label for="password">Contraseña *</label>
          <input 
            type="password" 
            id="password"
            formControlName="password"
            class="form-control"
            [class.error]="userForm.get('password')?.invalid && userForm.get('password')?.touched"
            placeholder="Mínimo 8 caracteres">
          <div class="error-message" *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched">
            <span *ngIf="userForm.get('password')?.errors?.['required']">Contraseña es requerida</span>
            <span *ngIf="userForm.get('password')?.errors?.['minlength']">Mínimo 8 caracteres</span>
          </div>
          <div class="help-text">
            <i class="fas fa-info-circle"></i>
            La contraseña debe tener al menos 8 caracteres. Si no se especifica, se generará una contraseña temporal.
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              formControlName="isActive"
              class="checkbox-input">
            <span class="checkbox-text">Usuario activo</span>
          </label>
        </div>
      </form>

      <div class="modal-footer">
        <button 
          type="button" 
          (click)="closeCreateModal()" 
          class="btn btn-secondary">
          Cancelar
        </button>
        <button 
          type="button" 
          (click)="createUser()" 
          [disabled]="userForm.invalid || loading"
          class="btn btn-primary">
          <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
          <i class="fas fa-save" *ngIf="!loading"></i>
          {{ loading ? 'Creando...' : 'Crear Usuario' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Gestión de Permisos -->
  <div class="modal-overlay" *ngIf="showPermissionModal" (click)="closePermissionModal()">
    <div class="modal-content large-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-key"></i>
          Gestionar Permisos - {{ selectedUser?.fullName }}
        </h3>
        <button (click)="closePermissionModal()" class="btn-close">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <form [formGroup]="permissionForm" class="permissions-form">
          <div class="permissions-grid" formArrayName="permissions">
            <div 
              *ngFor="let module of getPermissionControls(); let i = index"
              class="permission-module"
              [formGroupName]="i">
              
              <div class="module-header">
                <h4 class="module-name">{{ modules[i].name | titlecase }}</h4>
                <p class="module-description">{{ modules[i].description }}</p>
              </div>

              <div class="permissions-row" formGroupName="permissions">
                <label class="permission-checkbox">
                  <input type="checkbox" formControlName="read">
                  <span class="permission-label">Leer</span>
                </label>
                
                <label class="permission-checkbox">
                  <input type="checkbox" formControlName="create">
                  <span class="permission-label">Crear</span>
                </label>
                
                <label class="permission-checkbox">
                  <input type="checkbox" formControlName="update">
                  <span class="permission-label">Actualizar</span>
                </label>
                
                <label class="permission-checkbox">
                  <input type="checkbox" formControlName="delete">
                  <span class="permission-label">Eliminar</span>
                </label>
                
                <label class="permission-checkbox">
                  <input type="checkbox" formControlName="manage">
                  <span class="permission-label">Gestionar</span>
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button 
          type="button" 
          (click)="closePermissionModal()" 
          class="btn btn-secondary">
          Cancelar
        </button>
        <button 
          type="button" 
          (click)="savePermissions()" 
          [disabled]="loading"
          class="btn btn-primary">
          <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
          <i class="fas fa-save" *ngIf="!loading"></i>
          {{ loading ? 'Guardando...' : 'Guardar Permisos' }}
        </button>
      </div>
    </div>
  </div>
</div>
